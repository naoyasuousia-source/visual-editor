# 画像ロジック仕様書

---

## 1. 未解決要件

### 1.1 キャレット位置の微調整
- **要件**: 画像右辺キャレットを画像右辺から離れすぎているので、画像右辺から1.5pt右の位置に配置したい
- **現状**: `letter-spacing: 1.5pt` を画像段落に適用中。コンテナを一つの文字として扱い、直後のキャレットとの間隔を確保することで解決を試行中。

---

## 2. 未解決要件に関するコード変更履歴

### 2025-12-28 18:55 - 画像サイズ変更に伴うキャレット追従不全の修正
- **分析結果**:
  - 画像サイズクラス（`img-m`等）が内部の `img` にのみ適用されていたため、親である `inline-block` コンテナの幅が（％指定の直下でないため）正しく縮小せず、右辺の位置が固定されていた。
  - `letter-spacing` は文字間隔の制御には有効だが、今回のようにオブジェクトが単一の場合、ブラウザによって挙動が不安定になる可能性がある。
- **方針**:
  - サイズクラスを `.image-container` 自体に付与し、コンテナ自体の幅を 20% 〜 85% に制御。
  - 内部の `img` は `width: 100%` とし、コンテナに追随させる。
  - 1.5pt の余白は、コンテナの `margin-right: 1.5pt` で確保する。
- **変更内容**:
  - `customImage.ts`: `container` にクラスを付与するようロジック変更。
  - `content.css`: コンテナ幅の制御と `margin-right` への移行。

### 2025-12-28 18:45 - キャレット高さ調整と微調整の適用
- **分析結果**:
  - `line-height: 1.2` ではキャレットが標準テキストサイズに引っ張られ、画像高さをカバーできない。
  - 画像段落が画像コンテナ（inline-block）のみを含む場合、`line-height: 1` に設定することで行の高さがコンテナの高さと一致し、キャレットが画像全体をカバーする挙動になる（Chrome等の主要ブラウザ）。
- **方針**:
  - `line-height: 1` を画像段落に適用。
  - `letter-spacing: 1.5pt` を維持し、右辺の余白を確定。
- **変更内容**:
  ```css
  .page-inner p:has(> .image-container) {
    line-height: 1;
    letter-spacing: 1.5pt;
  }
  ```

### 2025-12-28 18:40 - キャレット位置調整（1.5pt右）の改善
- **分析結果**:
  - `margin` や `padding` では、ブラウザがキャレットを内容物（img）の端に吸着させてしまう傾向がある
  - `letter-spacing` を親の段落に適用すると、インラインブロック要素である画像コンテナの直後に正確な空白が生成される
- **方針**:
  - 画像段落のみに `letter-spacing: 1.5pt` を適用
- **変更内容**:
  ```css
  .page-inner p:has(> .image-container) {
    letter-spacing: 1.5pt;
  }
  ```

### 2025-12-28 18:35 - サブテキストタイトルのスタイル修正 ✅
- **分析結果**: 親要素の `font-size: 0` により、`em` 指定が 0 になっていた
- **方針**: `calc(11pt * 0.67)` で固定値指定
- **結果**: ✅ 正常動作確認済み

---

## 3. 分析中に気づいた重要ポイント
- **インラインブロックの幅確定**: 親要素が `inline-block` でその子が `%` 幅を持つ場合、親に明示的な幅がないとレイアウトが不安定（または intrinsic width に固定）になる。サイズクラスをコンテナ側に持たせることで、親（段落）に対する ％ 幅を確定させ、センタリング時の右辺位置を正しく計算させる。
- **インラインブロックの高さ**: `display: inline-block` を持つ画像コンテナは、親要素の `line-height` が 1.2 等の場合、ベースライン基準で高さが計算され、キャレットが画像の一部にしか表示されない。`line-height: 1` にすることで、行の高さがオブジェクトの高さそのものになり、キャレットが垂直方向をフルにカバーする。
- **キャレットの吸着特性**: `margin-right` を持つインラインブロックの直後にキャレットが発生する場合、多くのモダンブラウザはマージンの外側にキャレットを配置する。これにより、`letter-spacing` よりも直感的かつ確実に「画像から一定距離離れた位置」を確保できる。

---

## 4. 解決済み要件とその解決方法

---

## 5. 要件に関連する全ファイルのファイル構成
- `src/v2/lib/customImage.ts`: Tiptap NodeViewによるカスタム画像拡張の本体
- `src/v2/hooks/useImageActions.ts`: 画像の操作（リサイズ、枠線、メタデータ編集等）を管理するフック
- `src/v2/styles/content.css`: エディタ内画像およびキャレット制御用のグローバルスタイル
- `src/v2/hooks/useImageInsert.ts`: 画像挿入（ファイル選択、ドロップ）を管理するフック
- `src/v2/components/common/editor-menus/ImageBubbleMenu.tsx`: 画像選択時に表示されるツールバー

## 6. 要件に関連する技術スタック
- **Framework**: React 18
- **Editor Core**: Tiptap (ProseMirror)
- **Styling**: Tailwind CSS & Vanilla CSS (content.css)
- **Icons**: Lucide React

## 7. 要件に関する機能の動作原理
- **NodeViewによるカプセル化**: 画像を単なる `<img>` ではなく `image-container` (span) で包み、NodeViewとして定義することで、Reactのように振る舞わせつつProseMirrorのドキュメント構造に適合させている。
- **キャレットの強制配置**: `customImage.ts` の `addNodeView` 内で `mousedown` イベントを捕捉し、クリックされた際に `TextSelection` を用いて画像ノードの直後（pos + nodeSize）にキャレットを強制的に移動させる。
- **不可視のタイトル表現**: タイトル情報はDOM要素ではなく `data-title` 属性に保持し、CSSの `::after` 擬似要素で表示することで、エディタのテキスト選択やキャレット移動に干渉しないように設計されている。
- **キャレットの間隔制御**: `margin-right: 1.5pt` を `.image-container` に適用することで、インラインブロック要素の直後（右辺）に正確な物理的余白を確保し、ブラウザのキャレット配置を制御している。
