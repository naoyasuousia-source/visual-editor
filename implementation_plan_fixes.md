# バグ修正および改善の実装計画書

ユーザー様よりいただいた10項目の修正・改善要望に基づき、ファイル分割（リファクタリング）前に実施する修正計画をまとめました。

## 概要

**目的**: 現行の `index.html` および `main.ts` におけるUI/UXのバグ修正、挙動改善を行う。
**方針**: 機能追加ではなく、既存機能の品質向上を主眼に置く。各修正は現在の単一ファイル構成の状態で行い、動作確認後に完了とする。

---

## 修正項目と実装方針

### 1. 段落番号が消せてしまう問題の修正
*   **現状の課題**: ユーザー操作により段落番号（`data-para`属性）が意図せず消失する可能性がある。
*   **対応方針**:
    *   段落番号はCSSの `::before` で表示されているため、直接テキストとして消えることはないはずだが、段落の結合や削除操作で属性が失われる可能性がある。
    *   `input` イベントや `keyup` イベントを監視し、段落番号が必要な要素（hタグやpタグ）に `data-para` 属性が欠落している場合、自動的に再付与（採番）するロジックを強化する。
    *   特に、バックスペースでの段落結合時に番号が消える挙動を重点的にチェックし修正する。

### 2. 段落番号の位置固定（余白変更への対応）
*   **現状の課題**: 現在の番号位置はページ左端からの絶対位置計算（`calc`）になっているため、余白設定を変えると本文との距離が変わってしまう。
*   **対応方針**:
    *   番号の配置基準を「ページ左端」から「段落（本文）の左端」基準に変更する。
    *   CSSの `left` プロパティを、現在のMサイズ（余白17mm、番号位置6mm → 差分11mm）に合わせて、常に `left: -11mm` （またはそれに相当する固定値）とするよう修正する。
    *   これにより、余白S/Lに変更しても、本文と番号の距離感は維持される。

### 3. 図のタイトル変更時の既存値反映
*   **現状の課題**: タイトル設定ダイアログを開く際、常に入力欄が空になっており、編集が不便。
*   **対応方針**:
    *   `openTitleDialog` 関数を修正。
    *   選択中の画像に関連付けられた既存のタイトル要素（`.figure-title`）があるか確認し、存在する場合はそのテキスト内容を取得して、入力フォーム（`imageTitleInputElement`）の初期値としてセットする。

### 4. 取り消し線メニューの連続操作対応
*   **現状の課題**: 取り消し線を適用するとメニューが閉じてしまい、連続操作ができない。
*   **対応方針**:
    *   該当ボタンのクリックイベント処理において、メニューを閉じる処理（`closeFontSubmenu` 等）が呼び出されないように制御する。
    *   または、ボタンクリック後のフォーカスがエディタに戻る際、メニューの開閉状態を維持するように修正する。

### 5. ハイライト（タグ）の重複防止
*   **現状の課題**: 既にハイライトがある箇所に別の色を塗ると、`span` タグが入れ子になり、HTMLが汚れる。
*   **対応方針**:
    *   色適用処理（`applyColorHighlight`）の前に、選択範囲内の既存のハイライト用 `span` タグを検出し、一度解除（`unwrap`）するクリーンアップ処理を追加する。
    *   これにより、「塗り直し」の挙動を実現する。

### 6. フォントカラーの重複防止
*   **現状の課題**: ハイライトと同様、フォントカラー変更時にタグが多重化する。
*   **対応方針**:
    *   ハイライトと同様のアプローチで、`applyFontColor` 実行時に選択範囲内の既存の `font` タグや `span`（色指定あり）を整理するロジックを組み込む。

### 7. ブロック要素メニューの連続操作対応
*   **現状の課題**: ブロック要素（見出しなど）を選択するとメニューが閉じてしまう。
*   **対応方針**:
    *   取り消し線と同様、適用処理後にメニューを閉じるコードを削除、または条件付きにする。

### 8. メニューの排他制御（他を開いたら閉じる）
*   **現状の課題**: 複数のメニュー（フォント、段落、ファイル等）を同時に開けてしまう。
*   **対応方針**:
    *   各メニューを開く関数（`toggle...`系）の冒頭に、`closeAllMenus()` のような全メニュー閉鎖処理を追加する。
    *   これにより、常に「開いているメニューは一つだけ」の状態を保つ。

### 9. Align（整列）機能の初回バグ修正
*   **現状の課題**: 初回の整列適用時のみ、選択範囲が解除されメニューが閉じるなどの不安定な挙動がある。
*   **対応方針**:
    *   イベントリスナーの登録漏れや、初期化シーケンスの問題を調査。
    *   整列適用後に `focus()` や選択範囲の復元が正しく行われているかを確認し、修正する。

### 10. ぶら下げインデントの表示崩れ修正
*   **現状の課題**: 「ぶら下げ」適用時、2行目以降がインデント0の位置に来てしまい、1行目が突き抜けたように見える（あるいは意図しない配置になる）。
*   **対応方針**:
    *   ユーザー要望：「インデントは維持して、一行目だけインデント0になる（＝突き出し）」こと。
    *   例：全体がレベル2インデントの場合、2行目以降はレベル2の位置、1行目だけレベル1（あるいは0）の位置に出るようにしたい。
    *   CSSの修正：`.hanging-indent` クラスに対し、`text-indent`（負の値）と `padding-left`（正の値）の組み合わせを調整し、ベースのインデント（`.indent-X`）と共存できるよう計算式を見直す。

---

## 作業手順

1.  **CSS修正**: (項目2, 10) `index.html` 内の `<style>` ブロックを修正。
2.  **ロジック修正**: (項目1, 3, 5, 6) `src/main.ts` 内の該当関数を修正。
3.  **UI/イベント修正**: (項目4, 7, 8, 9) `src/main.ts` 内のイベントハンドラおよびメニュー制御ロジックを修正。

この計画に基づき、順次修正作業を開始します。
