# 出力HTML軽量化プロジェクト 実装計画書

## 1. プロジェクト概要

### 1.1 背景と目的
現在の出力HTMLは、本文が空の状態でも700行を超える非常に長いコードとなっており、AIに毎回読み込ませる際のコンテキスト消費が大きな問題となっています。本プロジェクトは、出力HTML及び関連CSSファイルを軽量化し、AIのコンテキスト消費を削減することを目的とします。

### 1.2 スコープ
- **対象ファイル**: `src/v2/styles/content.css`を中心とした出力HTML関連ファイル
- **対象外**: エディタの機能性や既存のスタイリング（出力HTML、エディタUI、各機能のスタイリング）を変更することは絶対に避ける

---

## 2. 現状分析

### 2.1 現在の問題点
1. **出力HTMLの肥大化**
   - 空の本文でも700行超え
   - AIのコンテキスト消費が過大
   
2. **content.cssの問題**
   - エディタ専用の機能（ハイライト機能など）が含まれている
   - 出力HTMLには不要な記述が混在
   - AI向けガイド文が冗長

### 2.2 影響範囲の調査
以下のファイルを確認する必要があります：
- `src/v2/styles/content.css` - メインターゲット
- `src/v2/components/` - content.cssから移動する機能の受け入れ先
- 出力HTML生成ロジック関連ファイル
- AI向けガイド文を含むファイル

---

## 3. 要件定義

### 3.1 機能要件

#### 3.1.1 content.cssのリファクタリング
- **R001**: 自動編集後のハイライト機能など、出力HTMLに関係のない記述をcontent.cssから削除する
- **R002**: 削除した機能は適切なReactコンポーネントに移行する
- **R003**: 出力HTMLのスタイリングは完全に維持する

#### 3.1.2 AI向けガイド文の最適化
- **R004**: AIが利用方法を間違えないように、わかりやすい記述は維持する
- **R005**: 冗長な説明を削除し、コンテキストサイズを削減する
- **R006**: 必要最小限の情報で正確な情報伝達を実現する

### 3.2 非機能要件

#### 3.2.1 品質要件
- **NR001**: 出力HTMLのスタイリングは絶対に崩さない
- **NR002**: エディタのスタイリングは絶対に崩さない
- **NR003**: 各機能のスタイリングは絶対に崩さない
- **NR004**: 既存の自動編集機能に影響を与えない

#### 3.2.2 パフォーマンス要件
- **NR005**: 出力HTMLのコンテキストサイズを50%以上削減する（目標）
- **NR006**: content.cssのサイズを30%以上削減する（目標）

---

## 4. 実装計画

### 4.1 フェーズ1: 調査・分析（所要時間: 1-2時間）

#### タスク1.1: content.cssの全体分析
- [ ] `src/v2/styles/content.css`の全行を精査
- [ ] 出力HTML専用のスタイルを特定
- [ ] エディタ専用のスタイルを特定
- [ ] 共通で使用されるスタイルを特定

#### タスク1.2: 依存関係の調査
- [ ] content.cssを参照しているすべてのコンポーネントをリストアップ
- [ ] 各スタイルの使用箇所を特定
- [ ] 削除候補のスタイルをマーキング

#### タスク1.3: 出力HTML生成ロジックの調査
- [ ] 出力HTMLがどのように生成されているかを確認
- [ ] content.cssがどのタイミングで組み込まれるかを確認
- [ ] 出力HTML内で実際に使用されているクラス/スタイルを特定

### 4.2 フェーズ2: 設計（所要時間: 2-3時間）

#### タスク2.1: 分離設計
- [ ] content.cssから削除するスタイルのリストを作成
- [ ] 各スタイルの移行先Reactコンポーネントを決定
- [ ] 新規CSSファイルが必要な場合、ファイル構成を設計

**想定される分離パターン:**
```
content.css (出力HTML用)
  ├─ 基本的なタイポグラフィ
  ├─ ページレイアウト
  ├─ 印刷スタイル
  └─ 段落・見出しスタイル

editor.css (エディタ専用 - 新規作成を検討)
  ├─ ハイライト機能
  ├─ カーソル表示
  ├─ 編集中のインタラクション
  └─ ツールバー関連スタイル
```

#### タスク2.2: AI向けガイド文の最適化設計
- [ ] 現在のガイド文を分析
- [ ] 削減可能な説明文を特定
- [ ] 最小限で正確な表現に書き換える案を作成

#### タスク2.3: 後方互換性の確保
- [ ] 既存の出力HTMLが正しく表示されるかの検証方法を設計
- [ ] テストケースを定義

### 4.3 フェーズ3: 実装（所要時間: 3-5時間）

#### タスク3.1: エディタ専用スタイルの移行
- [ ] `src/v2/styles/editor.css`（仮）を新規作成
- [ ] ハイライト機能関連のスタイルを移行
- [ ] その他エディタ専用スタイルを移行
- [ ] 関連コンポーネントのimport文を更新

#### タスク3.2: content.cssのクリーンアップ
- [ ] エディタ専用スタイルを削除
- [ ] 重複スタイルを統合
- [ ] 不要なコメントを削除
- [ ] 出力HTML必須スタイルのみを保持

#### タスク3.3: AI向けガイド文の書き換え
- [ ] 冗長な説明を削除
- [ ] 簡潔で正確な表現に書き換え
- [ ] 必要最小限の構造を維持

#### タスク3.4: Reactコンポーネントの更新
- [ ] スタイルを移行したコンポーネントのimportを更新
- [ ] インラインスタイルが必要な場合は適切に実装
- [ ] Tailwind CSSで代替可能なものは置き換え

### 4.4 フェーズ4: テスト・検証（所要時間: 2-3時間）

#### タスク4.1: ビジュアル回帰テスト
- [ ] 既存の出力HTMLを開いてスタイルが崩れていないか確認
- [ ] 新規に作成した文書を出力してスタイルを確認
- [ ] 各フォーマット（太字、斜体、リンクなど）が正しく表示されるか確認
- [ ] ページレイアウトが正しく維持されているか確認

#### タスク4.2: エディタ機能テスト
- [ ] ハイライト機能が正常に動作するか確認
- [ ] 自動編集機能が正常に動作するか確認
- [ ] コマンド承認/却下が正しく機能するか確認
- [ ] その他すべてのエディタ機能を確認

#### タスク4.3: コンテキストサイズの測定
- [ ] 最適化前の出力HTMLの行数を記録
- [ ] 最適化後の出力HTMLの行数を記録
- [ ] 削減率を計算
- [ ] content.cssのファイルサイズを比較

#### タスク4.4: 自動編集テスト
- [ ] test.htmlに各種コマンドを実行
- [ ] AIコマンドが正しく認識されるか確認
- [ ] 出力結果が正しいか確認

### 4.5 フェーズ5: ドキュメント化・完了（所要時間: 1時間）

#### タスク5.1: ドキュメント更新
- [ ] content.cssの構造変更を文書化
- [ ] 新規作成したファイルの役割を説明
- [ ] 移行ガイドを作成（必要に応じて）

#### タスク5.2: 実装結果の報告
- [ ] 削減したコンテキストサイズを報告
- [ ] 実装中に発見した問題点と対処方法を記録
- [ ] 今後の改善提案をリストアップ

---

## 5. リスク管理

### 5.1 予想されるリスク

| リスクID | リスク内容 | 影響度 | 発生確率 | 対策 |
|---------|-----------|--------|---------|------|
| R01 | スタイルの分離時に出力HTMLのレイアウトが崩れる | 高 | 中 | 段階的な移行と各段階でのビジュアル確認 |
| R02 | エディタのハイライト機能が動作しなくなる | 高 | 低 | 移行後の機能テストを徹底 |
| R03 | 既存の出力HTMLとの互換性が失われる | 中 | 低 | content.cssの出力用スタイルは削除しない |
| R04 | AI向けガイド文の削減でAIの理解精度が低下 | 中 | 中 | 段階的に削減し、都度AIでのテストを実施 |
| R05 | 想定外の依存関係により他機能に影響 | 中 | 中 | 事前の依存関係調査を徹底 |

### 5.2 リスク対応計画
- **即座のロールバック準備**: すべての変更前にGitコミットを作成
- **段階的実装**: 一度に大量の変更を行わず、小さな単位で実装とテストを繰り返す
- **テスト環境**: 本番HTMLファイルのバックアップを作成してからテストを実施

---

## 6. 成果物

### 6.1 コード成果物
1. **最適化されたcontent.css** - 出力HTML専用の軽量化されたスタイルシート
2. **editor.css（新規）** - エディタ専用のスタイルシート（必要に応じて）
3. **更新されたReactコンポーネント** - スタイル移行に伴う変更
4. **最適化されたAI向けガイド文** - content.css内およびその他の場所

### 6.2 ドキュメント成果物
1. **本実装計画書**（当ドキュメント）
2. **実装結果報告書** - 削減率、問題点、改善提案を含む
3. **スタイル構成ドキュメント** - 新しいCSS構成の説明

---

## 7. スケジュール概算

| フェーズ | タスク | 所要時間 | 累積時間 |
|---------|--------|---------|---------|
| フェーズ1 | 調査・分析 | 1-2時間 | 1-2時間 |
| フェーズ2 | 設計 | 2-3時間 | 3-5時間 |
| フェーズ3 | 実装 | 3-5時間 | 6-10時間 |
| フェーズ4 | テスト・検証 | 2-3時間 | 8-13時間 |
| フェーズ5 | ドキュメント化 | 1時間 | 9-14時間 |

**合計所要時間**: 9-14時間（作業内容により変動）

---

## 8. 次のアクション

本計画書を確認後、以下のアクションで開始することを推奨します：

1. ✅ 本計画書のレビューと承認
2. 🔜 **フェーズ1タスク1.1**: content.cssの全体分析から開始
3. 🔜 分析結果に基づき、具体的な削除・移行リストを作成

---

## 9. 補足情報

### 9.1 関連ドキュメント
- `.agent/rules.md` - プロジェクトルール
- `output-context.md` - 本プロジェクトの要件定義元

### 9.2 技術スタック
- **React** - UIコンポーネント
- **TypeScript** - 型安全性
- **CSS** - スタイリング
- **Tailwind CSS** - ユーティリティクラス（必要に応じて）

### 9.3 注意事項
- すべての変更は`rules.md`に準拠すること
- 型安全性を維持すること
- 4層アーキテクチャ（UI層、Hook層、Service層、Store層）を遵守すること
- 絶対にスタイリングを崩さないこと

---

**計画書作成日**: 2025-12-31  
**バージョン**: 1.0  
**ステータス**: 承認待ち
