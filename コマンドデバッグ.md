<uneditable>

## 概要
これは、解決困難な要件を効率的に解決するためのファイルである。要件に関する重要事項を随時追記修正することで、AIが状況を動的に把握しやすくするとともに、他のモデルも即座に状況を把握できるようにする。

## 厳守ルール
- <uneditable>タグ内は絶対に編集しないこと。
- このファイル内の<## 見出し>は絶対に編集しないこと。
- rules.mdに従うこと。**rules.mdの例外事項をよく読むこと**
- ローカルサーバーは絶対に立ち上げないこと。
- ユーザーからの指示があるまで、セクション1,4は編集しないこと。

## セクション1記述方法

<repuirement>
<content></content>
<current-situation></current-situation>
<remarks></remarks>
<permission-to-move>NG</permission-to-move>
</repuirement>

</uneditable>

----------------------------------------
# 以下、AIが自動的に更新する部分
----------------------------------------

## 1. 未解決要件（移動許可がNGの要件は絶対に移動・編集しないこと）

<repuirement>
<content>外部上書き検知～全体承認or全体破棄確定まではエディタをロックし、ユーザーは一切編集できないようにする。</content>
<current-situation>できてない</current-situation>
<remarks></remarks>
<permission-to-move>NG</permission-to-move>
</repuirement>

## 2. 未解決要件に関するコード変更履歴

### 重要な技術的発見事項

### 段落ID管理

- 段落ID形式: Paginatedモードは`p{page}-{paragraph}` (例: p1-2)、Wordモードは`p{number}` (例: p5)
- **修正**: `isOfficialId` が `p\\d+-\\d+` (Paginated) に加え、`p\\d+` (Word) も許容するように正規表現を更新。
- 仮ID形式: `temp-{uuid}` - INSERT/SPLIT実行時に自動生成

### HTMLコメントパースの堅牢化 (追記)

- **新たな発見**: AIガイド自体がHTMLコメント `<!-- ... -->` で囲まれており、その中のサンプルコードに `->` が含まれていると、そこでガイド全体のコメントが終了してしまうバグがあった。
- さらに、パーサーが最初に見つけたマーカーをコマンドエリアとして誤認し、ガイド内の空のエエリアをパースしていた。
- **修正**:
    - `aiMetadata.ts` 内のガイド用マーカー・サンプルを `[AI_COMMAND_START]` のように括弧形式に変更。
    - `extractCommandArea` を改良し、ファイル内の「最後」のマーカー対をコマンドエリアとして採用するように変更。

### 引数パース（カンマ問題）の解決

- **問題**: `REPLACE_PARAGRAPH(p1, Text with, comma, blockType=p)` のようにテキスト内にカンマがあると、引数が分割されすぎてオプションが正しく抽出されなかった。
- **修正**: 2番目以降の引数から `=` (key=value形式) を探すロジックを導入。`=` が最初に出現するまでの要素をすべて「テキスト」として再結合（カンマを復元）し、それ以降を「オプション」として扱うように改善。
- 引数抽出全体も `indexOf('(')` から `lastIndexOf(')')` までを取得するよう変更し、ネストしたカッコへの耐性を向上。

### コマンド検出の一貫性

- `hasNewCommands()` が単なる文字列マッチではなく、`extractCommands()` を通じて「実際に有効なコマンドが1つ以上あるか」を確認するように変更。

### 最終修正履歴（デバッグ用）

### 修正1: HTMLマーカー・コマンド抽出の正規表現化

**ファイル**: `src/v2/utils/htmlCommentParser.ts`**修正**: 固定文字列マッチから `RegExp` マッチへ変更。空白許容。

### 修正2: WordモードIDのサポート

**ファイル**: `src/v2/utils/paragraphIdManager.ts`**修正**: `isOfficialId`, `extractParagraphNumber` 等で `p{number}` 形式をサポート。

### 修正3: 引数の高度な抽出と再結合

**ファイル**: `src/v2/utils/newCommandParser.ts`**修正**: `extractArguments` の堅牢化、および `parseReplaceParagraph` / `parseInsertParagraph` でのテキストパーツ再結合ロジックの追加。

### 修正4: AIガイドの更新 (反映済み)

**ファイル**: `src/v2/utils/aiMetadata.ts`

### 修正5: 検出ロジックの同期

**ファイル**: `src/v2/hooks/useCommandParser.ts`**修正**: `hasNewCommands` のロジックを `extractCommands` ベースに統一。

### 重要な実装詳細

### ハイライトカラー (content.css)

- REPLACE: 青 `rgba(59, 130, 246, 0.2)`
- INSERT: 緑 `rgba(34, 197, 94, 0.2)`
- DELETE: 赤 + opacity:0.5 + 取り消し線
- MOVE: 紫 `rgba(168, 85, 247, 0.2)`
- SPLIT: オレンジ `rgba(249, 115, 22, 0.2)`
- MERGE: 青緑 `rgba(20, 184, 166, 0.2)`

### UIコンポーネント統合 (App.tsx)

- `useCommandApprovalController()` - ホバー検知とポップアップ制御
- `CommandPopup` - activePopupが存在する場合のみ表示
- `CommandApprovalBar` - showApprovalBar && pendingCount > 0で表示

## 3. 分析中に気づいた重要ポイント（試してだめだったこと、仮設、制約条件等...）

### 実装済み機能

- ✅ 6種類の新コマンド（REPLACE/INSERT/DELETE/MOVE/SPLIT/MERGE）
- ✅ 段落IDシステム (Paginated/Word両モード対応)
- ✅ 堅牢なHTMLコメントパーサー（空白許容）
- ✅ 高度な引数パーサー（テキスト内のカンマ対応）
- ✅ ハイライトシステム (6色・個別承認UI)
- ✅ AIガイド自動生成 (各モードのID形式を動的に反映)

### 既知の制約

- テキスト引数内に `=` が含まれていると、誤ってオプションの開始とみなされる可能性がある。
- Tiptapのノード位置計算は常に更新が必要（コマンド実行によってPosがずれるため、一括実行が望ましい）。
- **解決済み制約**: HTMLガイド内の `<!-- -->` がコメントを途切れさせ、パーサーを混乱させる問題は、ブラケット `[ ]` 形式への変更で解決。

### デバッグ時の確認ポイント

1. `htmlCommentParser` が `<!-- AI_COMMAND_START -->` を見つけられているか。
2. `isOfficialId` が現在のエディタモード（Paginated/Word）のIDを正しく検証できているか。
3. `extractArguments` がカッコ内の引数全てを配列として取得できているか。
4. `parseReplaceParagraph` 等の再結合ロジックが、期待通りテキストとオプションを分離できているか。

## 4. 解決済み要件とその解決方法

### test-commands-comprehensive.txt テストセット1のパース失敗

- **問題**: コマンドエリアのマッチングが厳密すぎ（空白に敏感）だったこと、およびWordモードの `p1` 形式のIDが「不正なID」として弾かれていた。さらに、AIガイド内のサンプルコード内の `->` がコメントを遮断し、パーサーを混乱させていた。
- **解決方法**:
    - `htmlCommentParser.ts` に正規表現を導入し、空白を許容する `COMMAND_START_REGEX` 等に変更。さらに「最後」のマーカー対を取得するように改良。
    - `paragraphIdManager.ts` の `isOfficialId` を更新し、`p{number}` 形式のWordモードIDを正式にサポート。
    - `aiMetadata.ts` 内のガイド用マーカー・サンプルを `[ ]` 形式に変更。
    - `newCommandParser.ts` で引数内のカンマをテキストとして安全に再結合するロジックを実装。

### 承認バー・ホバーポップアップ・編集フローの統合

- **解決方法**:
    - `CommandApprovalBar`: ツールバー直下に配置し、承認・破棄アクションで `saveFile` を自動実行。
    - `CommandPopup`: 位置計算用の `ref` 取得問題を解消（不透明な仮レンダリング導入）。同一段落内でのホバー維持ロジックにより安定化。
    - **自動編集フロー終了**: 全体承認/破棄実行後、ハイライトをすべてクリアし保存することで、後続の編集ができる状態への復帰を実装。

### 承認バーおよび個別承認ポップアップの表示不具合 & エディタのロック (再修正完了)

- **問題1 (表示)**: `CommandPopup` のレンダリングロジックが、位置が確定するまで `null` を返していたため、`ref` が取得できず位置計算がいつまでも始まらない「卵が先か鶏が先か」の状態になっていた。
- **問題2 (ロック)**: `useAutoEdit.ts` の完了処理で強制的に `setEditable(true)` が呼ばれていたため、承認待ちの間も編集ができてしまっていた。
- **問題3 (ホバー)**: マウスが段落内でわずかに動いただけで `mouseout` が判定され、タイマーがリセットされていた。
- **解決方法**:
    - `CommandPopup.tsx` を修正し、位置計算中も `opacity-0 invisible` 状態でレンダリングし、`ref` を確実に取得可能にした。
    - `useCommandApprovalController.ts` で `isAutoEditProcessing` と `pendingCount` の両方を監視し、`setTimeout(..., 0)` を使って強制的に `setEditable` を適用し続けるように堅牢化。
    - `useAutoEdit.ts` 側でも、保留中のハイライトがある場合は再有効化しないように制限を追加。
    - `handleMouseOut` に `relatedTarget` チェックを追加し、同一段落内やポップアップ本体への移動ではタイマーをリセットしないように改善。

## 5. 要件に関連する全ファイルのファイル構成（それぞれの役割を1行で併記）

### 型定義

- `src/v2/types/command.ts` - 新コマンド型、オプション、実行結果

### ユーティリティ

- `src/v2/utils/paragraphIdManager.ts` - ID生成・検証 (Wordモード対応)
- `src/v2/utils/paragraphOperations.ts` - 段落検索・操作
- `src/v2/utils/newCommandParser.ts` - 引数再結合ロジック含む
- `src/v2/utils/htmlCommentParser.ts` - 正規表現ベースへの進化
- `src/v2/utils/aiMetadata.ts` - AIガイド生成

### フック

- `src/v2/hooks/useCommandParser.ts` - 検出ロジックを抽出ベースに統一
- `src/v2/hooks/useAutoEdit.ts` - フロー全体を管理

## 6. 要件に関する機能の技術スタックと動作原理（依存関係含む）

### コマンド検出・抽出フロー

1. `useFileSystemWatcher` が変更を検知。
2. `htmlCommentParser` (正規表現) を使用して、マーカーに囲まれたエリアを抽出。
3. 同様に正規表現で、コメント形式のコマンド行をすべて取得。

### 引数パース原理 (Advanced Split)

- カッコ内の文字列をカンマで機械的に分割。
- 得られた要素の配列に対し、後ろから（オプションがある場合）処理を行い、オプションでない部分はすべて `text` としてカンマを付けて再結合する。これにより「テキスト内のカンマ」を安全に扱える。

### 個別承認の仕組み

- `data-command-type` 等の属性をノードに付与することでCSS（content.css）でのハイライトを実現。
- 承認時はそれらの属性を削除し、破棄時はキャプチャしておいたスナップショットに戻す。