# V2コード 新ルール準拠 実装計画書

## 概要

更新された [`rules.md`](file:///c:/Users/user/Desktop/ビジネス/project-root/.agent/rules.md) の要求事項に基づき、既存の `src/v2` コードベースを新ルールに準拠させるための修正計画を記述します。

**重要:** v1関連のコードには一切手を加えません。

---

## 現状分析

### ディレクトリ構造

`src/v2` の現在のディレクトリ構造は以下の通りです:

```
src/v2/
├── app/              # エントリーポイント (main.tsx, App.tsx)
├── components/       # UIコンポーネント
│   ├── ui/          # 基本コンポーネント (Shadcn/ui ベース)
│   ├── common/      # 共通コンポーネント
│   └── features/    # 機能別コンポーネント
├── constants/       # 定数
├── hooks/           # カスタムフック
├── lib/             # 外部ライブラリ設定 (Tiptap拡張など)
├── utils/           # ユーティリティ関数
├── services/        # API/外部通信
├── store/           # グローバル状態 (Zustand)
├── styles/          # CSS
└── types/           # TypeScript型定義
```

このディレクトリ構造は **rules.md のセクション3 (Directory structure) に準拠しています**。

---

## 新ルールとの差分・問題点

rules.md を詳細に確認した結果、以下の問題点・改善点を特定しました:

### 1. **App.tsx のコンポーネント肥大化 (300行制限違反)**

**問題:**
- [`App.tsx`](file:///c:/Users/user/Desktop/ビジネス/project-root/src/v2/app/App.tsx) が **280行** と非常に大きく、300行制限に近接しています。
- メインコンポーネント `EditorV3` が複数の責務を持ち、UIロジックとステート管理が混在しています。

**違反ルール:**
- **300-Line Limit (Section 1):** 1ファイル300行。
- **Logic & UI Separation (Section 1):** コンポーネントは描画とイベントの検知に専念すべき。

**影響:**
- 可読性・保守性の低下
- テストが困難

---

### 2. **App.tsx 内での直接的なイベントハンドラ定義 (ロジック分離不足)**

**問題:**
- [`App.tsx#L167-187`](file:///c:/Users/user/Desktop/ビジネス/project-root/src/v2/app/App.tsx#L167-187): `useEffect` 内で `handleKeyDown` が直接実装されています。
- この `handleKeyDown` はショートカットキー制御 (Ctrl+S, Ctrl+N, Ctrl+O) を実装していますが、コンポーネント内に記述されています。

**違反ルール:**
- **Bridge (hooks) (Section 1):** イベントハンドラロジックは `hooks/` に分離すべき。
- **コンポーネントの記述ルール (Section 1):** コンポーネントにはイベントハンドラの定義 (中身はhook/serviceの呼び出し) のみを書くべき。

**改善案:**
- `useKeyboardShortcuts` などの専用フックを作成し、ショートカットキー制御ロジックを分離する。

---

### 3. **Toolbar.tsx 内での直接的なTiptapコマンド実行 (ロジック分離不足)**

**問題:**
- [`Toolbar.tsx#L54-59`](file:///c:/Users/user/Desktop/ビジネス/project-root/src/v2/components/features/Toolbar.tsx#L54-59): コンポーネント内で `toggleBold`, `toggleItalic` などの関数が直接 Tiptap コマンドを実行しています。

```tsx
const toggleBold = () => editor.chain().focus().toggleBold().run();
const toggleItalic = () => editor.chain().focus().toggleItalic().run();
// ...
```

**違反ルール:**
- **Bridge (hooks) (Section 1):** ビジネスロジック (Tiptap操作) は `hooks/` で管理すべき。
- **コンポーネントの記述ルール (Section 1):** イベントハンドラの中身はhook/serviceの呼び出しに限定すべき。

**改善案:**
- `useTextFormatting` フックを作成し、テキスト書式設定ロジックを hooks/ に移動する。

---

### 4. **lib/ ディレクトリの用途不明確な実装 (DOM操作の外部化不足)**

**問題:**
- [`lib/customImage.ts`](file:///c:/Users/user/Desktop/ビジネス/project-root/src/v2/lib/customImage.ts) などの Tiptap 拡張定義は適切に `lib/` に配置されています。
- しかし、現状では **Tiptap拡張のReactサイクルへの適合** (useRef、useEffect による DOM 操作) が `hooks/` で明示的に管理されているかが不明確です。

**違反ルール:**
- **Reactライブラリの外部化 (Encapsulation) (Section 1):** 
  - `lib/` で初期設定を行い、`hooks/` で `useRef` や `useEffect` を用いてReactのサイクルに適合させる。
  - コンポーネントには `ref` を渡すための関数や、制御用のクリーンなインターフェースのみを公開する。

**改善案:**
- Tiptap エディタインスタンスの管理を `useEditor` フックから専用の `hooks/useTiptapEditor.ts` に分離し、拡張とReactサイクルの同期を明示的に管理する。

---

### 5. **useEffect の派生ステート同期 (禁止パターンの使用)**

**問題:**
- [`App.tsx#L157-163`](file:///c:/Users/user/Desktop/ビジネス/project-root/src/v2/app/App.tsx#L157-163): `isWordMode` が変更された際に、`useEffect` で `editor.setOptions` を実行しています。

```tsx
useEffect(() => {
    if (editor) {
        editor.setOptions({
            paragraphNumbering: { isWordMode },
        } as any);
    }
}, [isWordMode, editor]);
```

**違反ルール:**
- **同期と副作用の厳密ルール (Section 1):** 派生ステートを `useEffect` で同期させるのは禁止。
- **useEffectの限定利用 (Section 1):** `useEffect` は **DOM操作を伴う外部ライブラリの同期** にのみ使用すべき。

**改善案:**
- このケースは Tiptap という外部ライブラリの設定同期なので、`useEffect` の使用自体は許容範囲ですが、より明示的に「外部ライブラリの同期」であることをコメントで示すか、専用フックに分離すべきです。

---

### 6. **`any` 型の使用 (型安全性違反)**

**問題:**
複数箇所で `any` 型が使用されています:
- [`App.tsx#L66`](file:///c:/Users/user/Desktop/ビジネス/project-root/src/v2/app/App.tsx#L66): `const [tempEditor, setTempEditor] = useState<any>(null);`
- [`App.tsx#L161`](file:///c:/Users/user/Desktop/ビジネス/project-root/src/v2/app/App.tsx#L161): `} as any);`
- [`App.tsx#L211`](file:///c:/Users/user/Desktop/ビジネス/project-root/src/v2/app/App.tsx#L211): `} as any}`

**違反ルール:**
- **Type-Safe (Section 4):** `any` を禁止し、`unknown` と型ガードを活用せよ。

**改善案:**
- Tiptap の `Editor` 型を正しく定義し、適切な型アノテーションを使用する。
- `as any` を排除し、必要に応じて型ガードや型アサーションを使用する。

---

### 7. **Toolbar.tsx のファイルサイズ (224行、許容範囲だが分割推奨)**

**問題:**
- [`Toolbar.tsx`](file:///c:/Users/user/Desktop/ビジネス/project-root/src/v2/components/features/Toolbar.tsx) が **224行** あり、300行制限には収まっていますが、複数のサブメニューを統合管理しているため複雑です。

**違反ルール:**
- 厳密には違反していませんが、**300-Line Limit** の精神に則り、より細かくモジュール化すべきです。

**改善案:**
- 現状、`FileMenu`, `ViewMenu`, `ParagraphMenu`, `FontMenu`, `HighlightMenu` は別ファイルに分離されているため、これは良い設計です。
- Toolbar 自体は統合UIコンポーネントとして許容範囲ですが、さらに「Standard Mode Toolbar」と「Word Mode Toolbar」に分割することも検討可能です。

---

### 8. **コメント・TODO の不足 (Clean Code 原則)**

**問題:**
- 一部のファイルで、複雑なロジックに対するコメントが不足しています。
- `// TODO` や `// 実装予定` などのプレースホルダは見つかりませんでしたが、コード全体の可読性向上のためのドキュメンテーションコメントが不足しています。

**違反ルール:**
- **No Placeholders (Section 4):** `// TODO` や `// 実装予定` などのプレースホルダは一切排し、全ての関数を完結させよ。

**改善案:**
- 主要な関数・フックに JSDoc コメントを追加し、目的・引数・戻り値を明確にする。

---

## 提案する修正内容

以下の修正を段階的に実施します:

### フェーズ1: ロジック分離とフックの作成

#### 1.1. `hooks/useKeyboardShortcuts.ts` の作成

**目的:** ファイル保存・操作のショートカットキーロジックを App.tsx から分離。

**実装内容:**
- Ctrl+S, Ctrl+N, Ctrl+O のハンドリングを専用フックに移動
- `useEffect` でイベントリスナーを登録・解除
- クリーンアップ関数を確実に実装

**影響ファイル:**
- [NEW] [`hooks/useKeyboardShortcuts.ts`](file:///c:/Users/user/Desktop/ビジネス/project-root/src/v2/hooks/useKeyboardShortcuts.ts)
- [MODIFY] [`app/App.tsx`](file:///c:/Users/user/Desktop/ビジネス/project-root/src/v2/app/App.tsx)

---

#### 1.2. `hooks/useTextFormatting.ts` の作成

**目的:** テキスト書式設定 (Bold, Italic, Underline等) のロジックを Toolbar.tsx から分離。

**実装内容:**
- `toggleBold`, `toggleItalic`, `toggleUnderline`, `toggleStrike`, `toggleSuperscript`, `toggleSubscript` を専用フックに移動
- Editor インスタンスを引数に受け取り、書式設定メソッドを返す
- 書式のアクティブ状態取得メソッドも含める

**影響ファイル:**
- [NEW] [`hooks/useTextFormatting.ts`](file:///c:/Users/user/Desktop/ビジネス/project-root/src/v2/hooks/useTextFormatting.ts)
- [MODIFY] [`components/features/Toolbar.tsx`](file:///c:/Users/user/Desktop/ビジネス/project-root/src/v2/components/features/Toolbar.tsx)

---

#### 1.3. `hooks/useTiptapEditor.ts` の作成 (検討)

**目的:** Tiptap エディタインスタンスの初期化とライフサイクル管理を App.tsx から分離。

**実装内容:**
- `useEditor` の呼び出しを専用フックに移動
- 拡張の設定、イベントハンドラの登録をカプセル化
- エディタインスタンスとその制御メソッドを返す

**影響ファイル:**
- [NEW] [`hooks/useTiptapEditor.ts`](file:///c:/Users/user/Desktop/ビジネス/project-root/src/v2/hooks/useTiptapEditor.ts)
- [MODIFY] [`app/App.tsx`](file:///c:/Users/user/Desktop/ビジネス/project-root/src/v2/app/App.tsx)

**注意:**
- この修正は大規模になるため、ユーザーに確認が必要です。

---

### フェーズ2: App.tsx のリファクタリング

#### 2.1. App.tsx の責務分離

**目的:** App.tsx を純粋な「統合UIコンポーネント」に変更し、ロジックを完全に hooks に委譲。

**実装内容:**
- フェーズ1で作成したフックを使用
- コンポーネント内のロジックを最小化
- JSX構造の整理とコメントの追加

**影響ファイル:**
- [MODIFY] [`app/App.tsx`](file:///c:/Users/user/Desktop/ビジネス/project-root/src/v2/app/App.tsx)

---

### フェーズ3: 型安全性の向上

#### 3.1. `any` 型の排除

**目的:** `any` 型を `unknown` または適切な型に置き換え、型安全性を向上。

**実装内容:**
- `tempEditor` の型を `Editor | null` に修正
- `as any` アサーションを適切な型定義に置き換え
- Tiptap 拡張型の型定義ファイルを作成 (必要に応じて)

**影響ファイル:**
- [MODIFY] [`app/App.tsx`](file:///c:/Users/user/Desktop/ビジネス/project-root/src/v2/app/App.tsx)
- [MODIFY] [`types/tiptap.d.ts`](file:///c:/Users/user/Desktop/ビジネス/project-root/src/v2/types/tiptap.d.ts)

---

### フェーズ4: ドキュメンテーションとコードクリーンアップ

#### 4.1. JSDoc コメントの追加

**目的:** 主要な関数・フック・コンポーネントに JSDoc コメントを追加し、可読性を向上。

**実装内容:**
- 全てのカスタムフックに目的・引数・戻り値の説明を追加
- 複雑なロジックに説明コメントを追加

**影響ファイル:**
- [MODIFY] 全ての `hooks/*.ts` ファイル
- [MODIFY] 複雑なロジックを持つ `lib/*.ts` ファイル

---

#### 4.2. デッドコードの削除

**目的:** 未使用のインポート、変数、関数を削除。

**実装内容:**
- ESLint / TypeScript の未使用変数警告を確認
- 未使用コードを削除

**影響ファイル:**
- [MODIFY] 必要に応じて全てのファイル

---

## 検証計画

### 自動テスト

現時点で `src/v2` には自動テストが存在しないため、以下の検証方法を採用します:

1. **TypeScript コンパイルエラーチェック:**
   ```bash
   npm run build
   ```
   - エラーがないことを確認

2. **Lint チェック (存在する場合):**
   ```bash
   npm run lint
   ```

### 手動検証

以下の手動テストを実施します:

#### 1. エディタの基本動作確認
- [ ] `v2-editor.html` をブラウザで開く
- [ ] エディタが正常に読み込まれ、テキスト入力が可能
- [ ] 書式設定ボタン (B, I, U, S, X², X₂) が正常に動作
- [ ] ページ追加・削除が正常に動作

#### 2. ショートカットキー動作確認
- [ ] Ctrl+S でファイル保存ダイアログが表示される
- [ ] Ctrl+N で名前を付けて保存ダイアログが表示される
- [ ] Ctrl+O でファイルを開くダイアログが表示される

#### 3. Word モード切り替え確認
- [ ] 「Word互換モードに切替」ボタンで Word モードに切り替わる
- [ ] Word モードで段落番号が表示される
- [ ] 標準モードに戻す動作が正常

#### 4. 画像・リンク機能確認
- [ ] 画像挿入が正常に動作
- [ ] 画像のリサイズ・ボーダー設定が正常
- [ ] リンク挿入・削除が正常に動作

#### 5. ファイル保存・読み込み確認
- [ ] HTML ファイルの保存が正常
- [ ] 保存したファイルの読み込みが正常

---

## ユーザーレビュー必須事項

> [!IMPORTANT]
> 以下の点について、実装前にユーザーの確認が必要です:

### 1. `hooks/useTiptapEditor.ts` の作成について

**質問:**
- Tiptap エディタインスタンスの初期化を `App.tsx` から完全に分離し、専用フック `hooks/useTiptapEditor.ts` を作成しますか?
- これは大規模な変更となりますが、ロジックとUIの完全分離という観点では望ましいです。

**選択肢:**
- **案1 (推奨):** `useTiptapEditor` フックを作成し、エディタ初期化ロジックを完全に分離
- **案2:** エディタ初期化は `App.tsx` 内に残し、他のロジックのみフック化

---

### 2. フェーズ分割の優先順位

**質問:**
- 上記のフェーズ1〜4を全て実施しますか? それとも、優先度の高いフェーズから段階的に実施しますか?

**推奨:**
- まずフェーズ1 (ロジック分離) とフェーズ3 (型安全性) を優先実施
- フェーズ2, 4 は必要に応じて後回し

---

### 3. 既存機能への影響

**確認事項:**
- 本リファクタリングは、既存機能の動作に影響を与えないことを最優先とします。
- ロジックの分離は「内部構造の整理」であり、ユーザー体験やUIには一切変更を加えません。

---

## まとめ

本計画書では、`src/v2` コードベースを rules.md の新ルールに準拠させるための修正内容を提示しました。

**主な改善点:**
1. ロジックとUIの完全分離 (hooks の活用)
2. コンポーネントの肥大化防止 (300行制限遵守)
3. 型安全性の向上 (`any` 型の排除)
4. コードの可読性向上 (JSDoc コメント追加)

**次のステップ:**
- ユーザーによる本計画書のレビュー
- ユーザーレビュー必須事項への回答
- 承認後、フェーズ1から実装開始
