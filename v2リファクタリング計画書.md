# v2 コーディング規約（rules.md）準拠リファクタリング計画書

## 1. 概要
現在の `v2` コードベースを、`.agent/rules.md` に定義された「プロフェッショナルなシニアフロントエンドエンジニア」の基準および「4層アーキテクチャ」に厳密に従うようリファクタリングします。

## 2. 現状の不備（規約違反箇所）
分析の結果、以下の箇所で規約との乖離が見つかりました：

- **4層アーキテクチャの欠如**: `services/` ディレクトリが空であり、非同期処理（File System API等）が直接 `hooks/` に記述されている。
- **型安全性の不足**: `any` 型の使用が `WordBlockMenu.tsx` や `useTextFormatting.ts` などで見られる。
- **コンポーネント内での直接DOM操作**: `App.tsx` 内で `document.body` のクラス操作や `--page-margin` のスタイル設定が直接行われている。
- **相対パスの使用**: `main.tsx` で `./App` のような相対パスインポートが残っている（原則 `@/` を使用）。
- **インラインスタイルの使用**: `App.tsx` や `Toolbar.tsx` で、Tailwind で代替可能な箇所にインラインスタイルが使用されている。
- **ファイルの責務過多**: `App.tsx` に IME イベントの登録ロジックなどが混入している。

## 3. リファクタリング計画

### フェーズ 1: 4層アーキテクチャの徹底（Services層の構築）
- [ ] `src/v2/services/fileService.ts` を作成。
- [ ] `useFileIO.ts` から File System Access API (open/save/saveAs) のロジックを `fileService.ts` へ移動。
- [ ] `hooks/` はステート管理と UI への橋渡しに専念させる。

### フェーズ 2: 型安全性の強化とパスエイリアスの統一
- [ ] 全ファイルをスキャンし、`any` を `unknown` + 型ガード、または適切なインターフェースに置き換え。
    - 特に `useTextFormatting.ts` と `WordBlockMenu.tsx` の Tiptap 属性部分。
- [ ] `main.tsx` を含むすべての相対パスインポート (`./`, `../`) を `@/` エイリアスに統一。
- [ ] 必要に応じて `zod` を導入し、外部データ（インポートしたファイル内容等）のバリデーションを検討（規約の「必須実装パターン」に従う）。

### フェーズ 3: UI とロジックの完全分離
- [ ] `src/v2/hooks/useGlobalStyles.ts` を作成。
    - `isWordMode` に連動した `body` クラスの切り替えロジックを移動。
    - `--page-margin` の CSS 変数更新ロジックを移動。
- [ ] `src/v2/hooks/useIMEControl.ts` に、`App.tsx` 内の IME イベントリスナー登録ロジックを統合。
- [ ] `App.tsx` を純粋な UI 定義（JSX）のみにする。

### フェーズ 4: スタイリングの最適化
- [ ] `App.tsx` や `Toolbar.tsx` のインラインスタイル (`textShadow`, `width` 等) を Tailwind CSS に置き換え。
- [ ] 頻出する任意値（`h-[36px]` 等）を `tailwind.config.ts` のテーマ拡張（例：`height: { toolbar: '36px' }`）に定義し、トークンとして使用することを検討。

### フェーズ 5: ドキュメントとクリーンアップ
- [ ] すべての新規・既存の関数およびフックに JSDoc を付記。
- [ ] リファクタリング過程で発生したデッドコード（未使用の import 等）を完全に削除。

## 4. 制約事項
- `v1` 関連のファイル（`src/v1/`）には一切変更を加えない。
- 機能的なデグレードが発生しないよう、変更ごとに動作確認を行う。

## 5. 次のステップ
1. この計画書をプロジェクトルートに保存。
2. フェーズ 1 から順次実装を開始する。
