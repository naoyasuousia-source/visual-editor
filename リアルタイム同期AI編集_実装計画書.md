# リアルタイム同期AI編集機能 実装計画書 v2.0

**作成日**: 2025-12-29  
**最終更新**: 2025-12-29 12:23  
**バージョン**: 2.0（要件大幅変更）

---

## 📋 目次

1. [概要](#概要)
2. [変更履歴](#変更履歴)
3. [機能要件](#機能要件)
4. [ユーザーワークフロー](#ユーザーワークフロー)
5. [技術仕様](#技術仕様)
6. [UI/UX設計](#uiux設計)
7. [実装手順](#実装手順)
8. [テスト計画](#テスト計画)
9. [リスクと対策](#リスクと対策)
10. [成功指標](#成功指標)
11. [参考資料](#参考資料)

---

## 概要

### 目的
AntigravityなどのファイルベースAIエージェントがHTMLファイルを編集した際、その変更をブラウザのエディタにリアルタイムで反映し、ユーザーが承認または破棄できる機能を提供する。

### 主要機能
1. **自動ファイル監視**: エディタ起動時から0～3秒ごとに自動監視
2. **コマンド検知と実行**: HTMLコメント内のコマンドを検知・実行
3. **エディタロック**: 自動編集中はエディタを操作不可にし、「自動編集中」メッセージを表示
4. **変更ハイライト**: 自動編集された箇所をカラー表示
5. **承認/破棄機能**: AutoEditBarで変更を承認または破棄
6. **承認待ちロック**: 承認/破棄選択前は次の自動編集をブロック

---

## 変更履歴

### v2.0 (2025-12-29 12:23)
- **大幅な要件変更**
  - AI同期パネルを削除（自動監視のため不要）
  - AutoEditBarを新設（普段非表示、成功後のみ表示）
  - 承認/破棄フローを明確化
  - 承認待ち中のロック機能を追加
  - ファイル監視を自動開始（0～3秒間隔）

### v1.2 (2025-12-29 04:10)
- エディタロック機能の追加
- ブラウザ対応をChrome/Edgeのみに限定

### v1.1 (2025-12-29 02:30)
- 変更履歴管理機能を削除
- 自動保存タイミングを「コマンド実行前」に変更

### v1.0 (2025-12-29 00:00)
- 初版作成

---

## 機能要件

### 1. 自動ファイル監視
- **自動開始**: エディタ起動時に自動的に監視を開始
- **監視間隔**: 0～3秒ごとにポーリング（設定可能）
- **対象ファイル**: ユーザーが最初に開いたHTMLファイル
- **検知対象**: ファイルの最終更新時刻の変更

### 2. コマンドエリアの仕様
```html
<!-- AI_COMMAND_START -->
<!-- INSERT_TEXT[1:5][こんにちは] -->
<!-- REPLACE_TEXT[Hello][こんにちは][all] -->
<!-- AI_COMMAND_END -->
```

- **配置**: HTMLファイルの任意の位置（推奨: `<body>`直後）
- **形式**: HTMLコメント（ブラウザで直接開いても表示されない）
- **コマンド**: 1行に1コマンド、HTMLコメント形式で記述

### 3. 自動編集フロー

#### ステップ1: 変更検知
- ファイルの最終更新時刻をポーリング
- 変更を検知したらコマンドエリアの有無を確認

#### ステップ2: エディタロック
- エディタを操作不可に（`editor.setEditable(false)`）
- 画面全体に半透明オーバーレイを表示
- 「自動編集中」メッセージとローディングアニメーションを表示

#### ステップ3: コマンドエリアクリアと自動保存
- コマンドエリアの内容を空にする
- ファイルを上書き保存（File System Access API）

#### ステップ4: コマンド実行
- パースしたコマンドを順次実行
- 変更範囲を記録

#### ステップ5: 結果表示
- **成功時**:
  - エディタロックを解除
  - 変更箇所をカラー表示（黄色背景、5秒後にフェードアウト）
  - AutoEditBarを表示
- **失敗時**:
  - エディタロックを解除
  - エラーメッセージをトースト表示
  - AutoEditBarは表示しない

#### ステップ6: 承認/破棄待ち
- ユーザーが承認または破棄を選ぶまで**次の自動編集をブロック**
- ブロック中に変更を検知した場合、エラーメッセージを表示

#### ステップ7: 承認/破棄処理
- **承認時**:
  - 現在の状態でファイルを自動保存
  - AutoEditBarを非表示
  - 次の自動編集を許可
- **破棄時**:
  - エディタ内容を自動編集前の状態に復元
  - 復元後の状態でファイルを自動保存
  - AutoEditBarを非表示
  - 次の自動編集を許可

### 4. サポートするコマンド

#### Phase 1（初期実装）
- `INSERT_TEXT[位置][テキスト]`: テキスト挿入
- `REPLACE_TEXT[検索][置換][オプション]`: テキスト置換

#### Phase 2（追加実装）
- `DELETE_TEXT[範囲]`: テキスト削除
- `FORMAT_TEXT[範囲][書式]`: 書式変更
- `INSERT_PARAGRAPH[位置][テキスト]`: 段落挿入
- `DELETE_PARAGRAPH[段落番号]`: 段落削除

---

## ユーザーワークフロー

### 基本フロー

```
1. ユーザーがエディタでHTMLファイルを開く
   ↓
2. エディタが自動的にファイル監視を開始（0～3秒間隔）
   ↓
3. AIエージェント（Antigravity等）がHTMLファイルを編集
   ・コマンドエリアにコマンドを記述
   ・ファイルを保存
   ↓
4. エディタが変更を検知
   ・「自動編集中」メッセージ表示
   ・エディタをロック
   ↓
5. コマンドエリアをクリアしてファイル保存
   ↓
6. コマンドを実行
   ↓
7. 成功時
   ・変更箇所をカラー表示
   ・AutoEditBarを表示
   　- 最終自動編集：〇分前
   　- 変更承認ボタン
   　- 変更を破棄ボタン
   ↓
8. ユーザーが承認または破棄を選択
   ・承認 → ファイル保存 → AutoEditBar非表示 → 次の編集を許可
   ・破棄 → 編集前に復元 → ファイル保存 → AutoEditBar非表示 → 次の編集を許可
```

### エラーケース

#### 承認待ち中に次の変更が検知された場合
```
1. 承認/破棄待ちの状態
   ↓
2. AIエージェントが再度ファイルを編集
   ↓
3. エディタが変更を検知
   ↓
4. エラーメッセージを表示
   「前回の自動編集を承認または破棄してください」
   ↓
5. 自動編集をブロック（実行しない）
```

---

## 技術仕様

### アーキテクチャ

#### 4層アーキテクチャ（rules.md準拠）
```
utils/lib （純粋関数・ライブラリラッパー）
    ↓
services （ビジネスロジック）
    ↓
hooks （状態管理・副作用）
    ↓
components （UI描画）
```

### ディレクトリ構成
```
src/v2/
├── types/
│   └── ai-sync.types.ts          # 型定義
├── utils/
│   ├── htmlCommentParser.ts      # HTMLコメント解析
│   ├── commandValidator.ts       # コマンド検証
│   └── commandParser.ts          # コマンドパーサー
├── hooks/
│   ├── useFileSystemWatcher.ts   # ファイル監視
│   ├── useCommandParser.ts       # コマンド解析
│   ├── useCommandExecutor.ts     # コマンド実行
│   ├── useAutoEdit.ts            # 自動編集統合フック（新規）
│   └── useEditApproval.ts        # 承認/破棄管理（新規）
├── components/features/
│   ├── EditorLockOverlay.tsx     # エディタロック用オーバーレイ
│   └── AutoEditBar.tsx           # 自動編集バー（新規）
└── store/
    └── useAppStore.ts            # グローバル状態管理
```

### 主要コンポーネント・フック

#### 1. `useAutoEdit` - 自動編集統合フック
```typescript
interface UseAutoEditReturn {
  isProcessing: boolean;          // 自動編集中かどうか
  isPendingApproval: boolean;     // 承認待ちかどうか
  lastEditTime: number | null;    // 最終自動編集時刻
  error: string | null;           // エラーメッセージ
}
```

**責務**:
- ファイル監視の自動開始
- 変更検知時の自動編集フロー実行
- 承認待ちロックの管理

#### 2. `useEditApproval` - 承認/破棄管理フック
```typescript
interface UseEditApprovalReturn {
  approveEdit: () => Promise<void>;   // 変更を承認
  rejectEdit: () => Promise<void>;    // 変更を破棄
  canEdit: boolean;                   // 編集可能かどうか
}
```

**責務**:
- 編集前の状態を保存
- 承認時のファイル保存
- 破棄時の状態復元とファイル保存

#### 3. `AutoEditBar` - 自動編集バーコンポーネント
```typescript
interface AutoEditBarProps {
  lastEditTime: number;
  onApprove: () => void;
  onReject: () => void;
}
```

**表示内容**:
- 最終自動編集：〇分前
- 変更承認ボタン
- 変更を破棄ボタン

**表示条件**:
- 自動編集成功時のみ表示
- 承認または破棄後に非表示

#### 4. `EditorLockOverlay` - エディタロックオーバーレイ
**表示内容**:
- 半透明背景（`bg-black/30`）
- 「自動編集中」メッセージ
- ローディングアニメーション

**表示条件**:
- `isProcessing === true`のとき

### 状態管理（Zustand）

```typescript
interface AppState {
  // 自動編集関連
  isAutoEditProcessing: boolean;
  isEditPendingApproval: boolean;
  lastAutoEditTime: number | null;
  
  setAutoEditProcessing: (processing: boolean) => void;
  setEditPendingApproval: (pending: boolean) => void;
  setLastAutoEditTime: (time: number) => void;
}
```

### セキュリティ対策

#### 1. コマンドホワイトリスト
- 許可されたコマンドのみ実行
- 不正なコマンドは無視してログに記録

#### 2. 引数検証
- 位置・範囲の妥当性チェック
- 数値範囲のバリデーション
- 正規表現の構文チェック

#### 3. XSS対策
- テキスト挿入時のサニタイゼーション
- HTML特殊文字のエスケープ

#### 4. ファイルアクセス制限
- 最初に開いたファイルのみ監視
- 他のファイルへのアクセスを禁止

---

## UI/UX設計

### AutoEditBar

#### デザイン
```
┌─────────────────────────────────────────────────────────┐
│ 最終自動編集: 2分前  [変更を承認]  [変更を破棄]         │
└─────────────────────────────────────────────────────────┘
```

#### 配置
- ツールバーの直下
- エディタエリアの上

#### スタイル
- 背景: `bg-blue-50`
- ボーダー: `border-b border-blue-200`
- テキスト: `text-sm text-gray-700`
- 承認ボタン: `bg-green-600 hover:bg-green-700 text-white`
- 破棄ボタン: `bg-red-600 hover:bg-red-700 text-white`

### EditorLockOverlay

#### デザイン
```
┌─────────────────────────────────────┐
│                                     │
│          ⟳  自動編集中...           │
│                                     │
└─────────────────────────────────────┘
```

#### スタイル
- 背景: `bg-black/30 backdrop-blur-sm`
- z-index: `9999`
- メッセージ: `text-white text-lg font-medium`
- アニメーション: `animate-spin`（ローディングアイコン）

### 変更ハイライト

#### スタイル
- 背景: `bg-yellow-100`（黄色）
- アニメーション: フェードイン → 5秒待機 → フェードアウト
- 適用範囲: コマンドで変更されたテキスト部分

---

## 実装手順

### Phase 1: 基盤構築（完了）
- [x] 型定義
- [x] HTMLコメント解析
- [x] コマンド検証
- [x] コマンドパーサー

### Phase 2: コマンドシステム（完了）
- [x] ファイル監視フック
- [x] コマンド解析フック
- [x] コマンド実行フック（INSERT_TEXT, REPLACE_TEXT）

### Phase 3: 自動編集フロー（新規）
**推定時間**: 2-3日

#### タスク
- [ ] `useAutoEdit` フック実装
  - [ ] 自動監視開始
  - [ ] 変更検知時のフロー実行
  - [ ] 承認待ちロック機能
- [ ] `useEditApproval` フック実装
  - [ ] 編集前の状態保存
  - [ ] 承認処理（ファイル保存）
  - [ ] 破棄処理（状態復元 + ファイル保存）
- [ ] エディタロックの統合
- [ ] エラーハンドリング

### Phase 4: UIコンポーネント（更新）
**推定時間**: 1-2日

#### タスク
- [x] EditorLockOverlay（メッセージを「自動編集中」に変更）
- [ ] AutoEditBar（新規作成）
  - [ ] 最終編集時刻の表示
  - [ ] 承認ボタン
  - [ ] 破棄ボタン
- [ ] 既存エディタへの統合

### Phase 5: 変更ハイライト
**推定時間**: 1日

#### タスク
- [ ] 変更範囲の追跡
- [ ] ハイライト表示ロジック
- [ ] フェードアウトアニメーション

### Phase 6: 残りのコマンド実装
**推定時間**: 2-3日

#### タスク
- [ ] DELETE_TEXT
- [ ] FORMAT_TEXT
- [ ] INSERT_PARAGRAPH
- [ ] DELETE_PARAGRAPH

### Phase 7: テスト・最適化
**推定時間**: 2-3日

#### タスク
- [ ] 単体テスト
- [ ] 統合テスト
- [ ] E2Eテスト
- [ ] パフォーマンス最適化

### Phase 8: ドキュメント
**推定時間**: 1日

#### タスク
- [ ] ユーザーガイド
- [ ] AIエージェント向けAPI仕様書

**合計推定時間**: 10-14日

---

## テスト計画

### 単体テスト

#### 1. コマンドパーサー
- [ ] 各コマンドの正しいパース
- [ ] 不正なコマンドのエラー処理
- [ ] 引数のバリデーション

#### 2. コマンド実行
- [ ] INSERT_TEXTの正確な挿入
- [ ] REPLACE_TEXTの正確な置換
- [ ] エラーケースの処理

#### 3. 承認/破棄処理
- [ ] 承認時のファイル保存
- [ ] 破棄時の状態復元
- [ ] 復元後のファイル保存

### 統合テスト

#### 1. 自動編集フロー
- [ ] 変更検知からコマンド実行まで
- [ ] エディタロックの動作確認
- [ ] AutoEditBarの表示/非表示

#### 2. 承認待ちロック
- [ ] 承認前の次回編集ブロック
- [ ] エラーメッセージの表示
- [ ] 承認後の編集許可

### E2Eテスト

#### 1. 実際のAntigravity連携
- [ ] 単一コマンドの実行
- [ ] 複数コマンドの連続実行
- [ ] 承認/破棄の動作確認

#### 2. ブラウザ互換性
- [ ] Chrome最新版
- [ ] Edge最新版

---

## リスクと対策

### 1. File System Access APIの互換性
**リスク**: Chrome/Edge以外のブラウザで動作しない  
**対策**: Chrome/Edgeのみサポートを明示

### 2. ファイル変更検知の遅延
**リスク**: 0～3秒の遅延が発生  
**対策**: 許容範囲内として受け入れ

### 3. 承認待ち中の連続編集
**リスク**: AIが連続して編集しようとしてブロックされる  
**対策**: エラーメッセージで明確に通知

### 4. 複雑なコマンドの解析エラー
**リスク**: 特殊文字や入れ子構造でパースエラー  
**対策**: エラーメッセージをトースト表示

### 5. 大量のコマンド実行によるパフォーマンス低下
**リスク**: エディタが応答しなくなる  
**対策**: コマンド数に上限を設定（例: 50コマンド/回）

---

## 成功指標

### 機能正確性
- **目標**: 99%以上のコマンド実行成功率
- **測定**: テストケースの成功率

### 応答性
- **目標**: 変更検知から自動編集完了まで1秒以内
- **測定**: パフォーマンスログ

### 安定性
- **目標**: エラー発生率0.1%未満
- **測定**: エラーログの分析

### ユーザビリティ
- **目標**: ユーザー満足度4.5/5以上
- **測定**: ユーザーフィードバック

### 互換性
- **目標**: Chrome/Edgeで100%動作
- **測定**: ブラウザテスト結果

---

## 参考資料

### Web API
- [File System Access API - MDN](https://developer.mozilla.org/en-US/docs/Web/API/File_System_Access_API)
- [Tiptap Documentation](https://tiptap.dev/)

### 実装パターン
- [React Hooks Best Practices](https://react.dev/reference/react)
- [Zustand Documentation](https://zustand-demo.pmnd.rs/)

---

**文書管理情報**
- **ファイル名**: リアルタイム同期AI編集_実装計画書.md
- **最終更新者**: Antigravity AI
- **レビュー状態**: 承認待ち

## 1. 概要

### 1.1 目的
このv2エディタをネットで公開した際、ユーザーが自身のAntigravity等のファイル編集AIエージェント利用下で、エディタでリアルタイム同期AI編集ができるようにする。

### 1.2 設計思想
- **疑似API的コマンドロジック**: AIエージェントがHTMLファイルに特定コマンドを記述し、エディタがそれを検知・実行
- **ファイルシステム監視**: File System Access APIを使用してローカルファイル変更を検知
- **安全性重視**: 許可されたコマンドのみを実行し、セキュリティを確保
- **ユーザー制御**: コマンド実行前に自動保存し、変更不採用時は保存済みファイルをリロードして簡単に元に戻せる

---

## 2. 機能要件

### 2.1 コア機能

#### 2.1.1 ファイル変更検知
- **File System Access API**を使用して、開いているHTMLファイルの外部変更を検知
- ポーリングまたはイベントベースで変更を監視
- 変更検知時に自動でファイル内容を読み込み

#### 2.1.2 コマンドエリア
- HTMLファイル内に**専用のコマンドエリア**を設ける
  - 形式: `<!-- AI_COMMAND_START -->...<!-- AI_COMMAND_END -->`のようなHTMLコメント形式
  - ブラウザで直接ファイルを開いたときにゴミが表示されない
  - AIエージェントが容易に識別・編集できる

#### 2.1.3 コマンドパーサー
- コマンドエリアから有効なコマンドを抽出
- 許可されたコマンドのみを実行（ホワイトリスト方式）
- 不正なコマンドは無視し、エラーログを記録

#### 2.1.4 コマンド実行エンジン
以下のコマンドを実装:

1. **テキスト挿入**
   - `INSERT_TEXT[位置指定][テキスト]`
   - 段落番号、位置情報により挿入箇所を特定

2. **テキスト置換**
   - `REPLACE_TEXT[検索文字列][置換文字列][オプション]`
   - 正規表現サポート、部分一致・完全一致オプション

3. **テキスト削除**
   - `DELETE_TEXT[位置指定][範囲]`
   - 段落番号と範囲により削除箇所を特定

4. **書式変更**
   - `FORMAT_TEXT[位置指定][書式タイプ]`
   - 太字、斜体、下線、色などの書式変更

5. **段落操作**
   - `INSERT_PARAGRAPH[位置][テキスト]`
   - `DELETE_PARAGRAPH[段落番号]`
   - `MOVE_PARAGRAPH[元の位置][移動先位置]`

#### 2.1.5 変更のハイライト表示
- コマンドによって変更された箇所を視覚的に強調
  - 背景色: 薄い黄色またはパステルグリーン
  - アニメーション: フェードイン効果
  - タイムスタンプ表示
- 変更箇所にマウスホバーでコマンド詳細を表示

#### 2.1.6 エディタ操作ロック
- **ファイル変更検知からコマンド反映完了までエディタ操作を無効化**
- ロック中の動作:
  - エディタ全体に半透明オーバーレイを表示
  - ローディングインジケーター（スピナー）を中央に表示
  - 「AI編集を反映中...」などのメッセージ表示
  - すべてのキーボード入力・マウス操作を無効化
  - Tiptapエディタの`editable`プロパティを`false`に設定
- ロック解除タイミング:
  - コマンド実行完了後
  - 変更のハイライト表示が適用された後
  - エラー発生時も即座にロック解除

#### 2.1.7 自動保存とコマンド実行フロー
- **コマンド検知時の詳細フロー**:
  1. ファイル変更を検知
  2. **エディタをロック**（操作無効化、オーバーレイ表示）
  3. コマンドエリアを空にする
  4. HTMLファイルを自動保存（コマンド実行前の状態を保存）
  5. エディタでコマンドを実行
  6. 変更箇所をハイライト表示
  7. レンダリング完了を確認
  8. **エディタのロックを解除**（操作可能に戻す）
- **変更不採用時**: 保存済みファイルをリロードするだけで簡単に元の状態に復元可能
- 保存成功・失敗の通知をユーザーに表示
- **エラー時の処理**: コマンド実行失敗時も必ずロックを解除し、エラーメッセージを表示

---

## 3. ユーザーワークフロー

### 3.1 基本フロー
1. ユーザーがエディタからHTMLファイルを出力・保存
2. AIエージェント（Antigravity等）にHTMLファイルを読み込ませる
3. 同じHTMLファイルをエディタで開く（File System Access APIで書き込み権限を取得）
4. AIエージェントにテキスト編集の指示を出す
5. AIエージェントがHTMLファイル内のコマンドエリアにコマンドを記述
6. エディタがファイル変更を検知し、コマンドを実行
7. エディタ上で変更箇所がハイライト表示される
8. ユーザーが変更を確認
   - 承認: 変更を保持（そのまま編集を継続）
   - 却下: 保存済みHTMLファイルをリロードして元の状態に復元

### 3.2 AIエージェント向けガイド
HTMLファイル内に以下のようなコメントを埋め込む:

```html
<!-- 
=================================================
AIエージェント向けコマンド使用ガイド
=================================================

このファイルは、リアルタイム同期AI編集に対応しています。
以下のコマンドエリアに指定されたコマンドを記述してください。

■ コマンドエリア
AI_COMMAND_START と AI_COMMAND_END の間にコマンドを記述

■ 利用可能なコマンド
1. INSERT_TEXT[段落番号:位置][テキスト内容]
2. REPLACE_TEXT[検索文字列][置換文字列][オプション]
3. DELETE_TEXT[段落番号:開始位置-終了位置]
4. FORMAT_TEXT[段落番号:位置][書式]
5. INSERT_PARAGRAPH[挿入位置][テキスト内容]
6. DELETE_PARAGRAPH[段落番号]

■ 使用例
INSERT_TEXT[1:0][これは新しいテキストです]
REPLACE_TEXT[古いテキスト][新しいテキスト][all]
DELETE_PARAGRAPH[5]

=================================================
-->

<!-- AI_COMMAND_START -->
<!-- ここにコマンドを記述してください -->
<!-- AI_COMMAND_END -->
```

---

## 4. 技術仕様

### 4.1 使用技術
- **File System Access API**: ファイル変更監視と読み書き
- **Tiptap**: エディタのコマンド実行（既存の編集機能を活用）
- **React Hooks**: ファイル監視ロジックの実装
- **TypeScript**: 型安全なコマンドパーサーの実装

### 4.2 アーキテクチャ

#### 4.2.1 フォルダ構成
```
src/v2/
├── features/
│   └── ai-sync/
│       ├── hooks/
│       │   ├── useFileSystemWatcher.ts  # ファイル監視フック
│       │   ├── useCommandParser.ts       # コマンド解析フック
│       │   └── useCommandExecutor.ts     # コマンド実行フック
│       ├── components/
│       │   ├── AiSyncPanel.tsx           # AI同期制御パネル
│       │   ├── EditorLockOverlay.tsx     # エディタロック用オーバーレイ
│       │   └── ChangeHighlight.tsx       # 変更箇所ハイライト
│       ├── types/
│       │   └── command.types.ts          # コマンド型定義
│       └── utils/
│           ├── commandValidator.ts       # コマンド検証
│           └── htmlCommentParser.ts      # HTMLコメント解析
```

#### 4.2.2 コアフック詳細

**useFileSystemWatcher.ts**
```typescript
/**
 * File System Access APIを使用してファイル変更を監視
 */
export const useFileSystemWatcher = () => {
  const [fileHandle, setFileHandle] = useState<FileSystemFileHandle | null>(null);
  const [isWatching, setIsWatching] = useState(false);
  
  const startWatching = async () => { /* ... */ };
  const stopWatching = () => { /* ... */ };
  const checkForChanges = async () => { /* ... */ };
  
  return { startWatching, stopWatching, isWatching };
};
```

**useCommandParser.ts**
```typescript
/**
 * HTMLコメント内のコマンドを解析
 */
export const useCommandParser = () => {
  const parseCommands = (htmlContent: string): Command[] => { /* ... */ };
  const validateCommand = (command: Command): boolean => { /* ... */ };
  
  return { parseCommands, validateCommand };
};
```

**useCommandExecutor.ts**
```typescript
/**
 * Tiptapエディタでコマンドを実行
 */
export const useCommandExecutor = (editor: Editor | null) => {
  const executeCommand = (command: Command): ExecutionResult => { /* ... */ };
  const highlightChanges = (positions: Position[]): void => { /* ... */ };
  
  return { executeCommand, highlightChanges };
};
```



### 4.3 コマンド仕様

#### 4.3.1 コマンドフォーマット
```
COMMAND_NAME[引数1][引数2][オプション]
```

#### 4.3.2 位置指定方法
- `段落番号:文字位置` (例: `3:10` = 3段落目の10文字目)
- `段落番号:開始位置-終了位置` (例: `3:10-20` = 3段落目の10～20文字目)

#### 4.3.3 コマンド詳細仕様

| コマンド | 形式 | 例 |
|---------|------|-----|
| INSERT_TEXT | `INSERT_TEXT[位置][テキスト]` | `INSERT_TEXT[1:0][新しいテキスト]` |
| REPLACE_TEXT | `REPLACE_TEXT[検索][置換][オプション]` | `REPLACE_TEXT[古い][新しい][all]` |
| DELETE_TEXT | `DELETE_TEXT[範囲]` | `DELETE_TEXT[1:5-10]` |
| FORMAT_TEXT | `FORMAT_TEXT[範囲][書式]` | `FORMAT_TEXT[1:0-5][bold]` |
| INSERT_PARAGRAPH | `INSERT_PARAGRAPH[位置][テキスト]` | `INSERT_PARAGRAPH[3][新段落]` |
| DELETE_PARAGRAPH | `DELETE_PARAGRAPH[番号]` | `DELETE_PARAGRAPH[5]` |

---

## 5. セキュリティ対策

### 5.1 コマンド検証
- **ホワイトリスト方式**: 許可されたコマンドのみ実行
- **引数検証**: 各コマンドの引数を厳密に検証
- **サニタイゼーション**: XSS攻撃を防ぐためテキスト入力を適切にエスケープ

### 5.2 エラーハンドリング
- 不正なコマンドは無視し、エラーログに記録
- ユーザーに通知を表示（例: "無効なコマンドが検出されました"）
- コマンド実行失敗時は変更を適用せず、元の状態を維持

### 5.3 ファイルアクセス制限
- ユーザーが明示的に許可したファイルのみアクセス
- File System Access APIの権限プロンプトを活用

---

## 6. UI/UX設計

### 6.1 AI同期制御パネル
- **位置**: エディタ右上または右サイドバー
- **要素**:
  - "AI同期を開始" / "AI同期を停止" トグルボタン
  - 現在の監視状態インジケーター（緑: 監視中、グレー: 停止中）
  - 最終同期時刻表示
  - "変更を破棄（リロード）" ボタン

### 6.2 エディタロック中のUI
- **オーバーレイ**:
  - エディタ全体を覆う半透明の背景（`bg-black/30`または`bg-gray-900/40`）
  - z-indexを高く設定してすべての操作をブロック
- **ローディング表示**:
  - 中央にスピナーアイコン（回転アニメーション）
  - 「AI編集を反映中...」のメッセージテキスト
  - フォントサイズ: 16px、色: 白または明るいグレー
- **アニメーション**: フェードイン/フェードアウト（150ms）でスムーズに表示・非表示

### 6.3 変更ハイライト
- **背景色**: `bg-yellow-100` (Tailwind CSS)
- **アニメーション**: `animate-pulse` を一時的に適用
- **ツールチップ**: マウスホバーで実行されたコマンドを表示



---

## 7. 実装手順

### Phase 1: 基盤構築（1-2日）
1. `ai-sync/` フォルダ構造作成
2. 型定義ファイル作成（`command.types.ts`）
3. `useFileSystemWatcher` フック実装
4. HTMLコメント解析ユーティリティ作成

### Phase 2: コマンドシステム（2-3日）
1. `useCommandParser` フック実装
2. コマンド検証ロジック実装
3. `useCommandExecutor` フック実装
4. 基本コマンド（INSERT_TEXT, REPLACE_TEXT）の実装

### Phase 3: 変更ハイライト（1日）
1. 変更ハイライト機能実装
2. ハイライトのフェードアウトアニメーション実装

### Phase 4: UIコンポーネント（1-2日）
1. `EditorLockOverlay` コンポーネント作成（エディタロック用オーバーレイ）
2. `AiSyncPanel` コンポーネント作成
3. `ChangeHighlight` コンポーネント作成
4. 既存エディタUIへの統合
5. エディタロック状態管理の実装

### Phase 5: 残りのコマンド実装（2-3日）
1. DELETE_TEXT コマンド実装
2. FORMAT_TEXT コマンド実装
3. INSERT_PARAGRAPH / DELETE_PARAGRAPH コマンド実装
4. コマンド拡張のためのプラグインシステム設計

### Phase 6: テスト・最適化（2-3日）
1. 単体テスト作成
2. 統合テスト（実際のAIエージェントとの連携テスト）
3. パフォーマンス最適化
4. エラーハンドリング強化

### Phase 7: ドキュメント・公開準備（1日）
1. ユーザー向けガイド作成
2. AIエージェント向けAPI仕様書作成
3. デモ動画作成

**合計推定作業時間: 9-14日**

---

## 8. テスト計画

### 8.1 単体テスト
- 各コマンドパーサーのテスト
- コマンド実行ロジックのテスト
- 検証ロジックのテスト

### 8.2 統合テスト
- ファイル変更検知からコマンド実行までのフロー
- 自動保存とリロードによる復元
- エラーケースのハンドリング

### 8.3 E2Eテスト
- 実際のAntigravityを使用した連携テスト
- 複数コマンドの連続実行テスト
- ブラウザ互換性テスト（Chrome, Edge）

---

## 9. リスクと対策

### 9.1 技術的リスク

| リスク | 影響度 | 対策 |
|-------|--------|------|
| File System Access APIのブラウザ互換性 | 高 | Polyfillまたはフォールバック機能の実装 |
| ファイル変更検知の遅延 | 中 | ポーリング間隔の最適化、ユーザーへの通知 |
| 大規模ファイルでのパフォーマンス低下 | 中 | 差分検出アルゴリズムの最適化 |
| コマンド解析の誤動作 | 高 | 厳密なパーサーテスト、フェイルセーフ実装 |

### 9.2 セキュリティリスク

| リスク | 影響度 | 対策 |
|-------|--------|------|
| 悪意のあるコマンド実行 | 高 | ホワイトリスト方式、厳密な検証 |
| XSS攻撃 | 高 | テキスト入力のサニタイゼーション |
| 不正なファイルアクセス | 中 | File System Access APIの権限管理活用 |

---

## 10. 成功指標

1. **機能正確性**: コマンド実行成功率 > 99%
2. **応答性**: ファイル変更検知から実行まで < 1秒
3. **安定性**: コマンド実行エラー率 < 0.1%
4. **ユーザビリティ**: ユーザーテストでの満足度 > 4.5/5
5. **互換性**: 対応ブラウザ（Chrome, Edge）での正常動作

---

## 11. 参考資料

- [File System Access API - MDN](https://developer.mozilla.org/en-US/docs/Web/API/File_System_Access_API)
- [Tiptap Commands Documentation](https://tiptap.dev/api/commands)
- プロジェクト内 `rules.md` - コーディング規約
- `src/v2/` ディレクトリ - 既存のエディタ実装

---

**文書作成日**: 2025-12-29  
**最終更新日**: 2025-12-29  
**作成者**: Antigravity AI Assistant  
**バージョン**: 1.1  

### 変更履歴
- **v1.1 (2025-12-29)**: ユーザーフィードバックに基づき修正
  - 変更履歴管理機能を削除（不採用）
  - 自動保存タイミングを変更（コマンド実行直前に保存）
  - 将来の拡張可能性セクションを削除
  - 推定作業時間を再計算（9-14日に短縮）
  - ブラウザ対応をChrome/Edgeのみに限定（Safari除外）
  - エディタ操作ロック機能を追加（ファイル変更検知～コマンド反映完了まで）
