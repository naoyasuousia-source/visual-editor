# リアルタイム同期AI編集 実装計画書

## 1. 概要

### 1.1 目的
このv2エディタをネットで公開した際、ユーザーが自身のAntigravity等のファイル編集AIエージェント利用下で、エディタでリアルタイム同期AI編集ができるようにする。

### 1.2 設計思想
- **疑似API的コマンドロジック**: AIエージェントがHTMLファイルに特定コマンドを記述し、エディタがそれを検知・実行
- **ファイルシステム監視**: File System Access APIを使用してローカルファイル変更を検知
- **安全性重視**: 許可されたコマンドのみを実行し、セキュリティを確保
- **ユーザー制御**: コマンド実行前に自動保存し、変更不採用時は保存済みファイルをリロードして簡単に元に戻せる

---

## 2. 機能要件

### 2.1 コア機能

#### 2.1.1 ファイル変更検知
- **File System Access API**を使用して、開いているHTMLファイルの外部変更を検知
- ポーリングまたはイベントベースで変更を監視
- 変更検知時に自動でファイル内容を読み込み

#### 2.1.2 コマンドエリア
- HTMLファイル内に**専用のコマンドエリア**を設ける
  - 形式: `<!-- AI_COMMAND_START -->...<!-- AI_COMMAND_END -->`のようなHTMLコメント形式
  - ブラウザで直接ファイルを開いたときにゴミが表示されない
  - AIエージェントが容易に識別・編集できる

#### 2.1.3 コマンドパーサー
- コマンドエリアから有効なコマンドを抽出
- 許可されたコマンドのみを実行（ホワイトリスト方式）
- 不正なコマンドは無視し、エラーログを記録

#### 2.1.4 コマンド実行エンジン
以下のコマンドを実装:

1. **テキスト挿入**
   - `INSERT_TEXT[位置指定][テキスト]`
   - 段落番号、位置情報により挿入箇所を特定

2. **テキスト置換**
   - `REPLACE_TEXT[検索文字列][置換文字列][オプション]`
   - 正規表現サポート、部分一致・完全一致オプション

3. **テキスト削除**
   - `DELETE_TEXT[位置指定][範囲]`
   - 段落番号と範囲により削除箇所を特定

4. **書式変更**
   - `FORMAT_TEXT[位置指定][書式タイプ]`
   - 太字、斜体、下線、色などの書式変更

5. **段落操作**
   - `INSERT_PARAGRAPH[位置][テキスト]`
   - `DELETE_PARAGRAPH[段落番号]`
   - `MOVE_PARAGRAPH[元の位置][移動先位置]`

#### 2.1.5 変更のハイライト表示
- コマンドによって変更された箇所を視覚的に強調
  - 背景色: 薄い黄色またはパステルグリーン
  - アニメーション: フェードイン効果
  - タイムスタンプ表示
- 変更箇所にマウスホバーでコマンド詳細を表示

#### 2.1.6 エディタ操作ロック
- **ファイル変更検知からコマンド反映完了までエディタ操作を無効化**
- ロック中の動作:
  - エディタ全体に半透明オーバーレイを表示
  - ローディングインジケーター（スピナー）を中央に表示
  - 「AI編集を反映中...」などのメッセージ表示
  - すべてのキーボード入力・マウス操作を無効化
  - Tiptapエディタの`editable`プロパティを`false`に設定
- ロック解除タイミング:
  - コマンド実行完了後
  - 変更のハイライト表示が適用された後
  - エラー発生時も即座にロック解除

#### 2.1.7 自動保存とコマンド実行フロー
- **コマンド検知時の詳細フロー**:
  1. ファイル変更を検知
  2. **エディタをロック**（操作無効化、オーバーレイ表示）
  3. コマンドエリアを空にする
  4. HTMLファイルを自動保存（コマンド実行前の状態を保存）
  5. エディタでコマンドを実行
  6. 変更箇所をハイライト表示
  7. レンダリング完了を確認
  8. **エディタのロックを解除**（操作可能に戻す）
- **変更不採用時**: 保存済みファイルをリロードするだけで簡単に元の状態に復元可能
- 保存成功・失敗の通知をユーザーに表示
- **エラー時の処理**: コマンド実行失敗時も必ずロックを解除し、エラーメッセージを表示

---

## 3. ユーザーワークフロー

### 3.1 基本フロー
1. ユーザーがエディタからHTMLファイルを出力・保存
2. AIエージェント（Antigravity等）にHTMLファイルを読み込ませる
3. 同じHTMLファイルをエディタで開く（File System Access APIで書き込み権限を取得）
4. AIエージェントにテキスト編集の指示を出す
5. AIエージェントがHTMLファイル内のコマンドエリアにコマンドを記述
6. エディタがファイル変更を検知し、コマンドを実行
7. エディタ上で変更箇所がハイライト表示される
8. ユーザーが変更を確認
   - 承認: 変更を保持（そのまま編集を継続）
   - 却下: 保存済みHTMLファイルをリロードして元の状態に復元

### 3.2 AIエージェント向けガイド
HTMLファイル内に以下のようなコメントを埋め込む:

```html
<!-- 
=================================================
AIエージェント向けコマンド使用ガイド
=================================================

このファイルは、リアルタイム同期AI編集に対応しています。
以下のコマンドエリアに指定されたコマンドを記述してください。

■ コマンドエリア
AI_COMMAND_START と AI_COMMAND_END の間にコマンドを記述

■ 利用可能なコマンド
1. INSERT_TEXT[段落番号:位置][テキスト内容]
2. REPLACE_TEXT[検索文字列][置換文字列][オプション]
3. DELETE_TEXT[段落番号:開始位置-終了位置]
4. FORMAT_TEXT[段落番号:位置][書式]
5. INSERT_PARAGRAPH[挿入位置][テキスト内容]
6. DELETE_PARAGRAPH[段落番号]

■ 使用例
INSERT_TEXT[1:0][これは新しいテキストです]
REPLACE_TEXT[古いテキスト][新しいテキスト][all]
DELETE_PARAGRAPH[5]

=================================================
-->

<!-- AI_COMMAND_START -->
<!-- ここにコマンドを記述してください -->
<!-- AI_COMMAND_END -->
```

---

## 4. 技術仕様

### 4.1 使用技術
- **File System Access API**: ファイル変更監視と読み書き
- **Tiptap**: エディタのコマンド実行（既存の編集機能を活用）
- **React Hooks**: ファイル監視ロジックの実装
- **TypeScript**: 型安全なコマンドパーサーの実装

### 4.2 アーキテクチャ

#### 4.2.1 フォルダ構成
```
src/v2/
├── features/
│   └── ai-sync/
│       ├── hooks/
│       │   ├── useFileSystemWatcher.ts  # ファイル監視フック
│       │   ├── useCommandParser.ts       # コマンド解析フック
│       │   └── useCommandExecutor.ts     # コマンド実行フック
│       ├── components/
│       │   ├── AiSyncPanel.tsx           # AI同期制御パネル
│       │   ├── EditorLockOverlay.tsx     # エディタロック用オーバーレイ
│       │   └── ChangeHighlight.tsx       # 変更箇所ハイライト
│       ├── types/
│       │   └── command.types.ts          # コマンド型定義
│       └── utils/
│           ├── commandValidator.ts       # コマンド検証
│           └── htmlCommentParser.ts      # HTMLコメント解析
```

#### 4.2.2 コアフック詳細

**useFileSystemWatcher.ts**
```typescript
/**
 * File System Access APIを使用してファイル変更を監視
 */
export const useFileSystemWatcher = () => {
  const [fileHandle, setFileHandle] = useState<FileSystemFileHandle | null>(null);
  const [isWatching, setIsWatching] = useState(false);
  
  const startWatching = async () => { /* ... */ };
  const stopWatching = () => { /* ... */ };
  const checkForChanges = async () => { /* ... */ };
  
  return { startWatching, stopWatching, isWatching };
};
```

**useCommandParser.ts**
```typescript
/**
 * HTMLコメント内のコマンドを解析
 */
export const useCommandParser = () => {
  const parseCommands = (htmlContent: string): Command[] => { /* ... */ };
  const validateCommand = (command: Command): boolean => { /* ... */ };
  
  return { parseCommands, validateCommand };
};
```

**useCommandExecutor.ts**
```typescript
/**
 * Tiptapエディタでコマンドを実行
 */
export const useCommandExecutor = (editor: Editor | null) => {
  const executeCommand = (command: Command): ExecutionResult => { /* ... */ };
  const highlightChanges = (positions: Position[]): void => { /* ... */ };
  
  return { executeCommand, highlightChanges };
};
```



### 4.3 コマンド仕様

#### 4.3.1 コマンドフォーマット
```
COMMAND_NAME[引数1][引数2][オプション]
```

#### 4.3.2 位置指定方法
- `段落番号:文字位置` (例: `3:10` = 3段落目の10文字目)
- `段落番号:開始位置-終了位置` (例: `3:10-20` = 3段落目の10～20文字目)

#### 4.3.3 コマンド詳細仕様

| コマンド | 形式 | 例 |
|---------|------|-----|
| INSERT_TEXT | `INSERT_TEXT[位置][テキスト]` | `INSERT_TEXT[1:0][新しいテキスト]` |
| REPLACE_TEXT | `REPLACE_TEXT[検索][置換][オプション]` | `REPLACE_TEXT[古い][新しい][all]` |
| DELETE_TEXT | `DELETE_TEXT[範囲]` | `DELETE_TEXT[1:5-10]` |
| FORMAT_TEXT | `FORMAT_TEXT[範囲][書式]` | `FORMAT_TEXT[1:0-5][bold]` |
| INSERT_PARAGRAPH | `INSERT_PARAGRAPH[位置][テキスト]` | `INSERT_PARAGRAPH[3][新段落]` |
| DELETE_PARAGRAPH | `DELETE_PARAGRAPH[番号]` | `DELETE_PARAGRAPH[5]` |

---

## 5. セキュリティ対策

### 5.1 コマンド検証
- **ホワイトリスト方式**: 許可されたコマンドのみ実行
- **引数検証**: 各コマンドの引数を厳密に検証
- **サニタイゼーション**: XSS攻撃を防ぐためテキスト入力を適切にエスケープ

### 5.2 エラーハンドリング
- 不正なコマンドは無視し、エラーログに記録
- ユーザーに通知を表示（例: "無効なコマンドが検出されました"）
- コマンド実行失敗時は変更を適用せず、元の状態を維持

### 5.3 ファイルアクセス制限
- ユーザーが明示的に許可したファイルのみアクセス
- File System Access APIの権限プロンプトを活用

---

## 6. UI/UX設計

### 6.1 AI同期制御パネル
- **位置**: エディタ右上または右サイドバー
- **要素**:
  - "AI同期を開始" / "AI同期を停止" トグルボタン
  - 現在の監視状態インジケーター（緑: 監視中、グレー: 停止中）
  - 最終同期時刻表示
  - "変更を破棄（リロード）" ボタン

### 6.2 エディタロック中のUI
- **オーバーレイ**:
  - エディタ全体を覆う半透明の背景（`bg-black/30`または`bg-gray-900/40`）
  - z-indexを高く設定してすべての操作をブロック
- **ローディング表示**:
  - 中央にスピナーアイコン（回転アニメーション）
  - 「AI編集を反映中...」のメッセージテキスト
  - フォントサイズ: 16px、色: 白または明るいグレー
- **アニメーション**: フェードイン/フェードアウト（150ms）でスムーズに表示・非表示

### 6.3 変更ハイライト
- **背景色**: `bg-yellow-100` (Tailwind CSS)
- **アニメーション**: `animate-pulse` を一時的に適用
- **ツールチップ**: マウスホバーで実行されたコマンドを表示



---

## 7. 実装手順

### Phase 1: 基盤構築（1-2日）
1. `ai-sync/` フォルダ構造作成
2. 型定義ファイル作成（`command.types.ts`）
3. `useFileSystemWatcher` フック実装
4. HTMLコメント解析ユーティリティ作成

### Phase 2: コマンドシステム（2-3日）
1. `useCommandParser` フック実装
2. コマンド検証ロジック実装
3. `useCommandExecutor` フック実装
4. 基本コマンド（INSERT_TEXT, REPLACE_TEXT）の実装

### Phase 3: 変更ハイライト（1日）
1. 変更ハイライト機能実装
2. ハイライトのフェードアウトアニメーション実装

### Phase 4: UIコンポーネント（1-2日）
1. `EditorLockOverlay` コンポーネント作成（エディタロック用オーバーレイ）
2. `AiSyncPanel` コンポーネント作成
3. `ChangeHighlight` コンポーネント作成
4. 既存エディタUIへの統合
5. エディタロック状態管理の実装

### Phase 5: 残りのコマンド実装（2-3日）
1. DELETE_TEXT コマンド実装
2. FORMAT_TEXT コマンド実装
3. INSERT_PARAGRAPH / DELETE_PARAGRAPH コマンド実装
4. コマンド拡張のためのプラグインシステム設計

### Phase 6: テスト・最適化（2-3日）
1. 単体テスト作成
2. 統合テスト（実際のAIエージェントとの連携テスト）
3. パフォーマンス最適化
4. エラーハンドリング強化

### Phase 7: ドキュメント・公開準備（1日）
1. ユーザー向けガイド作成
2. AIエージェント向けAPI仕様書作成
3. デモ動画作成

**合計推定作業時間: 9-14日**

---

## 8. テスト計画

### 8.1 単体テスト
- 各コマンドパーサーのテスト
- コマンド実行ロジックのテスト
- 検証ロジックのテスト

### 8.2 統合テスト
- ファイル変更検知からコマンド実行までのフロー
- 自動保存とリロードによる復元
- エラーケースのハンドリング

### 8.3 E2Eテスト
- 実際のAntigravityを使用した連携テスト
- 複数コマンドの連続実行テスト
- ブラウザ互換性テスト（Chrome, Edge）

---

## 9. リスクと対策

### 9.1 技術的リスク

| リスク | 影響度 | 対策 |
|-------|--------|------|
| File System Access APIのブラウザ互換性 | 高 | Polyfillまたはフォールバック機能の実装 |
| ファイル変更検知の遅延 | 中 | ポーリング間隔の最適化、ユーザーへの通知 |
| 大規模ファイルでのパフォーマンス低下 | 中 | 差分検出アルゴリズムの最適化 |
| コマンド解析の誤動作 | 高 | 厳密なパーサーテスト、フェイルセーフ実装 |

### 9.2 セキュリティリスク

| リスク | 影響度 | 対策 |
|-------|--------|------|
| 悪意のあるコマンド実行 | 高 | ホワイトリスト方式、厳密な検証 |
| XSS攻撃 | 高 | テキスト入力のサニタイゼーション |
| 不正なファイルアクセス | 中 | File System Access APIの権限管理活用 |

---

## 10. 成功指標

1. **機能正確性**: コマンド実行成功率 > 99%
2. **応答性**: ファイル変更検知から実行まで < 1秒
3. **安定性**: コマンド実行エラー率 < 0.1%
4. **ユーザビリティ**: ユーザーテストでの満足度 > 4.5/5
5. **互換性**: 対応ブラウザ（Chrome, Edge）での正常動作

---

## 11. 参考資料

- [File System Access API - MDN](https://developer.mozilla.org/en-US/docs/Web/API/File_System_Access_API)
- [Tiptap Commands Documentation](https://tiptap.dev/api/commands)
- プロジェクト内 `rules.md` - コーディング規約
- `src/v2/` ディレクトリ - 既存のエディタ実装

---

**文書作成日**: 2025-12-29  
**最終更新日**: 2025-12-29  
**作成者**: Antigravity AI Assistant  
**バージョン**: 1.1  

### 変更履歴
- **v1.1 (2025-12-29)**: ユーザーフィードバックに基づき修正
  - 変更履歴管理機能を削除（不採用）
  - 自動保存タイミングを変更（コマンド実行直前に保存）
  - 将来の拡張可能性セクションを削除
  - 推定作業時間を再計算（9-14日に短縮）
  - ブラウザ対応をChrome/Edgeのみに限定（Safari除外）
  - エディタ操作ロック機能を追加（ファイル変更検知～コマンド反映完了まで）
