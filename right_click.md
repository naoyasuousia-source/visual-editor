## 概要
これは、解決困難な要件を効率的に解決するためのファイルである。要件に関する重要事項を随時追記修正することで、AIが状況を動的に把握しやすくするとともに、他のモデルも即座に状況を把握できるようにする。

内容は以下の通りとする。
1.未解決要件、2.未解決要件に関するコード変更履歴（毎回、分析結果・方針・変更内容を詳細に記述する）3.分析中に気づいた重要ポイント（試してだめだったこと、仮設、制約条件等...）、4.解決済み要件とその解決方法、5.要件に関連する全ファイルのファイル構成、6.要件に関連する技術スタック、7.要件に関する機能の動作原理（依存関係含む）

## ワークフロー

### 現状把握と分析
まず、1を確認して未解決要件を把握する。
その後、2～7を参考にしつつ、コードベースを分析して、現状の問題点を考える。
同時に、3を更新する。

### 5～7の更新
分析を踏まえて、5～7を更新する。
***常に、最新の要件に関連する記述を行い、最新の要件に関係のない記述は削除すること。***

### コード編集作業
次に、実際に要件を満たすためにコーディングを行う。途中、適宜3を更新する。

### 作業終了後
作業後は、ユーザーから、フィードバックを受けたのち、ユーザーの指示に従って、1,4を更新する。
***勝手に1,4を編集しないこと。***

----------------------------------------
# 以下、AIが自動的に更新する部分
----------------------------------------

## 1. 未解決要件
・A4領域右クリでデフォルトメニュー表示かつ、画像に関しては右クリで画像メニュー表示するようにしたい。
**現在、A4の地の領域でも右クリで画像メニューが出る状態になってしまっている。**

## 2. 未解決要件に関するコード変更履歴

### 2025-12-29 - 右クリックメニュー共存修正

#### 分析結果
- 原因: `selectImageAt` が DOM 要素 (`target`) だけに依存しており、Tiptap の `NodeView` による複雑な DOM 階層下では判定に失敗することがあった。また、内側のエディタがイベントを吸収していた。

#### 実装方針
- `useImageActions.ts`: `selectImageAt` にマウス座標 (`clientX`, `clientY`) による判定を追加。
- `ImageContextMenu.tsx`: `onContextMenuCapture` を使用して、イベントが停止される前にキャッチする。画像以外の場合は早期リターンしてブラウザに委ねる。

#### 変更内容

**修正: `src/v2/hooks/useImageActions.ts`**
- `selectImageAt`: `posAtCoords` を使用したフォールバック判定を実装。

**修正: `src/v2/components/common/editor-menus/ImageContextMenu.tsx`**
- イベントハンドラを `onContextMenuCapture` に変更。
- 画像上でのみ `e.preventDefault()` と `e.stopPropagation()` を実行。

### 2025-12-29 (2) - 誤判定の修正

#### 分析結果
- 原因: `selectImageAt` 内の `target.querySelector('img')` が、クリックされた要素の子孫にある画像を無差別に検索してしまっている。
- 具体例: エディタの背景やページ要素をクリックした際、その中に画像が含まれていると、その画像がターゲットとして誤認される。

#### 実装方針
- `selectImageAt` のロジックを厳格化。
- `querySelector` は、`target` が明確に `.image-container` である場合のみ使用するように変更、あるいは削除して `closest` と `posAtCoords` だけにする。

## 3. 分析中に気づいた重要ポイント
- `onContextMenuCapture` は正しく機能しているが、その中で呼ぶ判定関数が `true` を返しすぎていることが問題。

## 4. 解決済み要件とその解決方法
- **A4領域でのブラウザ標準メニュー表示**: `selectImageAt` の判定厳格化（子孫探索の廃止）と、イベント透過により実現。
- **画像上でのカスタムメニュー表示**: `onContextMenuCapture` で検出し、`DropdownMenu` を指定座標で開くことで実現。

## 5. 要件に関連する全ファイルのファイル構成
- `src/v2/components/common/editor-menus/ImageContextMenu.tsx` - 右クリックハンドラ本体（DropdownMenu使用に変更）
- `src/v2/hooks/useImageActions.ts` - 画像判定ロジック

## 6. 要件に関連する技術スタック
- Tiptap / ProseMirror - エディタ本体
- Radix UI Dropdown Menu - カスタムメニュー制御（Virtual Triggerパターン）

## 7. 要件に関する機能の動作原理
1. ユーザーが右クリック。
2. `ImageContextMenu` の `Capture` ハンドラが座標を取得。
3. 座標の下に `image` ノードがあるか判定。
4. 画像なら `e.preventDefault()` して `DropdownMenu` を指定座標で開く。
5. 画像でないなら、そのままイベントを流し、ブラウザが標準メニューを表示する。
