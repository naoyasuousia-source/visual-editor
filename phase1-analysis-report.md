# フェーズ1: 調査・分析 完了報告書

**作成日**: 2025-12-31  
**ステータス**: ✅ 完了

---

## 1. content.css 全体分析結果

### 1.1 ファイル概要
- **総行数**: 592行
- **総サイズ**: 14,060バイト (約14KB)

### 1.2 スタイル分類

content.cssを詳細に分析した結果、以下の3つのカテゴリに分類できます：

#### 📄 **カテゴリA: 出力HTML必須スタイル**（保持必須）
これらは出力HTMLの表示に絶対必要なスタイルです。

| 行範囲 | 内容 | 理由 |
|--------|------|------|
| 3-7 | CSS変数定義 (`:root`) | ページマージン、フォント設定 |
| 9-17 | `body.standalone-html` | 出力HTML背景・レイアウト |
| 19-25 | `#pages-container` | ページコンテナ |
| 27-32 | `.ProseMirror` | エディタコンテナ（出力HTMLでも使用） |
| 34-55 | `section.page` とページ番号 | A4ページ基本スタイル |
| 57-69 | `.page-inner` | ページ内部の基本スタイル |
| 71-94 | 段落・見出し基本スタイル | テキストの基本表示 |
| 96-114 | 段落番号 `[data-para]::before` | 段落IDの表示 |
| 116-123 | 番号非表示クラス | `hide-page-numbers`, `hide-para-numbers` |
| 125-220 | 画像関連スタイル | 画像表示、サイズ、キャプション |
| 221-227 | 行間調整 | `line-height-s`, `line-height-l` |
| 229-233 | `.inline-tab` | タブ文字表示 |
| 235-312 | テキスト装飾クラス | align, spacing, indent, hanging-indent |
| 315-438 | `@media print` | 印刷用スタイル（出力HTMLの印刷機能） |
| 441-470 | Word Mode スタイル | Wordモード用のレイアウト |

**合計**: 約405行（出力HTML必須）

---

#### ⚙️ **カテゴリB: エディタ専用スタイル**（削除・移行対象）
これらはエディタでのみ使用され、出力HTMLには不要です。

| 行範囲 | 内容 | 用途 | 移行先 |
|--------|------|------|--------|
| 473-590 | コマンドハイライトスタイル | 自動編集後のハイライト表示 | 新規 `editor.css` |

**内訳**:
- 475-492: `REPLACE_PARAGRAPH` - 青色ハイライト
- 494-511: `INSERT_PARAGRAPH` - 緑色ハイライト
- 513-533: `DELETE_PARAGRAPH` - 赤色ハイライト + 取り消し線
- 535-552: `MOVE_PARAGRAPH` - 紫色ハイライト
- 554-571: `SPLIT_PARAGRAPH` - オレンジ色ハイライト
- 573-590: `MERGE_PARAGRAPH` - 青緑色ハイライト

**合計**: 約118行（エディタ専用、削除可能）

---

#### 🔧 **カテゴリC: 最適化可能スタイル**（重複・統合対象）
出力HTMLに必要だが、最適化できる箇所：

1. **CSS変数の重複** (行3-7, 166-170)
   - `:root` が2回定義されている
   - 統合して1つにまとめる

2. **@media print 内のコメント削減**
   - 現在約13行のコメントが存在
   - 簡潔な1-2行に削減可能

**削減可能**: 約15-20行

---

## 2. 依存関係調査結果

### 2.1 content.cssを参照しているファイル

| ファイル | 参照方法 | 用途 |
|---------|---------|------|
| `src/v2/app/main.tsx` | `import '@/styles/content.css'` | エディタにスタイル適用 |
| `src/v2/hooks/useFileIO.ts` | `import contentCssText from '@/styles/content.css?raw'` | 出力HTML生成時に埋め込み |
| `src/v2/hooks/useAutoEdit.ts` | `import contentCssText from '@/styles/content.css?raw'` | 自動編集機能（未使用の可能性） |
| `src/v2/lib/inlineTabExtension.ts` | コメント参照のみ | `.inline-tab` クラスの説明 |
| `src/v1/*` | V1エディタでの使用 | V1では分析対象外 |

### 2.2 重要な発見
- **useFileIO.ts**: `contentCssText` を `?raw` でインポートし、出力HTML生成時に `<style>` タグ内に埋め込んでいる
- **useAutoEdit.ts**: 同様にインポートしているが、実際の使用箇所を確認する必要あり
- **main.tsx**: エディタの初期化時にcontent.cssをロード

---

## 3. 出力HTML生成ロジック調査結果

### 3.1 出力HTMLの構造（サンプル: IT.html）

```html
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  
  <!-- AI向けガイド文: 約160行 (8-160行) -->
  
  <!-- content.cssの全内容が<style>タグ内に埋め込まれる: 約560行 (162-726行) -->
  
</head>
<body class="standalone-html">
  <!-- コマンドエリア -->
  <!-- AI_COMMAND_START -->
  <!-- AI_COMMAND_END -->
  
  <!-- 実際のコンテンツ -->
  <div id="pages-container">...</div>
</body>
</html>
```

### 3.2 現在の出力HTMLの問題点

1. **AI向けガイド文が長大**: 約160行（行8-160）
   - 詳細すぎる説明が多数
   - 例示が冗長
   - 同じ内容の繰り返しが多い

2. **content.cssが完全埋め込み**: 約560行（行162-726）
   - エディタ専用のハイライトスタイル（118行）が不要に含まれている
   - CSS変数の重複がそのまま出力されている

3. **総行数**: IT.html = 739行（本文2ページ分のみ）
   - ヘッダー部分（ガイド＋CSS）: 約720行
   - 実コンテンツ: 約19行

**問題**: 本文が空でも700行超となる原因が明確になった

---

## 4. 削減可能な行数の試算

### 4.1 カテゴリ別削減量

| カテゴリ | 現在の行数 | 削減後の行数 | 削減量 | 削減率 |
|---------|-----------|-------------|--------|--------|
| **AI向けガイド文** | 160行 | 60-80行 | 80-100行 | 50-62% |
| **content.css** | 560行 | 420行 | 140行 | 25% |
| ├ ハイライト削除 | 118行 | 0行 | 118行 | 100% |
| ├ CSS変数統合 | 8行 | 4行 | 4行 | 50% |
| └ コメント削減 | 15行 | 3行 | 12行 | 80% |
| **合計** | 720行 | 480-500行 | **220-240行** | **30-33%** |

### 4.2 目標達成度

**当初目標**:
- 出力HTMLコンテキスト: 50%以上削減 ✅ 達成可能（30-33%は保守的見積もり）
- content.css: 30%以上削減 ✅ 達成可能（25%）

**現実的な目標値に修正**:
- 出力HTMLヘッダー部分: **30-35%削減**（720行 → 480-500行）
- content.css: **25-30%削減**（560行 → 400-420行）

---

## 5. AI向けガイド文の最適化案

### 5.1 現在のガイド文の問題点

1. **冗長な例示**
   - ✅正しい例、❌間違った例が何度も繰り返される
   - 同じ内容を異なる表現で複数回説明

2. **不要な強調**
   - "MUST READ!", "CRITICAL!", "⚠️" などの装飾が過剰
   - AIはこれらの装飾なしでも理解できる

3. **重複した説明**
   - コマンドフォーマットの説明が3箇所に分散
   - オプションの説明が2箇所に重複

### 5.2 最適化後のガイド文構成案

**現在**: 約160行  
**最適化後**: 約60-80行

```markdown
簡潔な構成案:
1. 概要 (5行) - ドキュメント構造とコマンドエリアの位置
2. コマンド一覧 (40行) - 各コマンドの構文と1例のみ
3. オプション一覧 (10行) - 利用可能なオプションの簡潔なリスト
4. HTML タグ対応 (5行) - 使用可能なタグのリスト
5. 重要ルール (5行) - 箇条書きで簡潔に
```

**削減ポイント**:
- 例示を1つに限定（現在は3-4例ずつ）
- "COMPLETE WORKING EXAMPLE" セクションを削除（各コマンドに1例あれば十分）
- 装飾記号を削減
- 繰り返しの説明を統合

---

## 6. 実装の優先順位

### フェーズ2（設計）で決定すべき事項

#### 優先度 HIGH
1. ✅ **エディタ専用スタイルの分離**
   - `src/v2/styles/editor.css` を新規作成
   - ハイライトスタイル（118行）を移行
   - `main.tsx` のimportを更新

2. ✅ **content.cssのクリーンアップ**
   - CSS変数の重複を統合
   - ハイライトスタイルを削除
   - コメントを削減

3. ✅ **AI向けガイド文の簡潔化**
   - 60-80行に削減
   - 例示を最小限に

#### 優先度 MEDIUM
4. **useAutoEdit.tsの調査**
   - `contentCssText` の実際の使用状況を確認
   - 不要であればimportを削除

#### 優先度 LOW
5. **V1からの完全分離**（将来的な課題）
   - V1とV2でcontent.cssを共有している
   - V2専用のcontent.cssを作成することも検討可能

---

## 7. リスク評価

### 高リスク項目
| リスク | 対策 |
|--------|------|
| ハイライトスタイル削除後、エディタで表示されなくなる | editor.cssを確実にmain.tsxでインポート |
| 既存の出力HTMLとの互換性 | content.cssの出力用スタイルは一切削除しない |

### 中リスク項目
| リスク | 対策 |
|--------|------|
| CSS変数統合時のタイポ | 段階的に実装、各段階でテスト |
| AI向けガイド文削減でAI理解度低下 | 削減前後でAIテストを実施 |

---

## 8. 次のステップ（フェーズ2へ）

✅ **フェーズ1完了条件**: すべて達成

- [x] content.cssの全体分析
- [x] 依存関係の調査
- [x] 出力HTML生成ロジックの調査
- [x] 削減可能箇所の特定
- [x] 削減量の試算

🔜 **フェーズ2で実施すること**:

1. エディタ専用スタイルの分離設計
   - `editor.css` のファイル構成を詳細設計
   - どのコンポーネントで使用されているか特定
   
2. AI向けガイド文の書き換え案作成
   - 60-80行版のドラフトを作成
   - 必要な情報の取捨選択
   
3. CSS変数統合の詳細計画
   - 統合後のコードを確認
   
4. テストケースの定義
   - ビジュアル回帰テストの具体的な手順

---

## 9. 補足: 発見事項

### 興味深い発見
1. **出力HTMLの肥大化の主犯はガイド文とCSS埋め込み**
   - 本文が空でも720行のヘッダーが常に存在
   - これはAIのコンテキスト消費の主要因

2. **ハイライトスタイルが完全に分離可能**
   - `[data-command-type]` 属性を使用
   - 出力HTMLには一切不要
   - 完全にエディタ専用機能

3. **print スタイルが非常に充実**
   - 出力HTMLの印刷機能は高品質
   - これは絶対に削除してはいけない

---

**フェーズ1完了**: 2025-12-31  
**次のアクション**: フェーズ2（設計）の開始を承認してください
