# 開発・デバッグ用重要ナレッジ集

このファイルは、`debug-command.md` と `temp-id.md` の内容を統合し、今後のデバッグや機能拡張に際して重要となる技術仕様・注意点をまとめたものです。

---

## 1. 段落ID・仮IDシステム

### ID形式
- **正式ID**: エディタのモードによって形式が異なります。
  - **Paginatedモード**: `p{page}-{paragraph}` (例: `p1-2`)
  - **Wordモード**: `p{number}` (例: `p5`)
- **仮ID (tempId)**: `INSERT_PARAGRAPH` や `SPLIT_PARAGRAPH` で新しく作られる段落にAIが指定するIDです。
  - 形式: `temp-[\w-]+` (例: `temp-1`, `temp-chain-1`)
  - **必須ルール**: 同一ターン内での連続操作（例: 挿入した直後に移動）を可能にするため、AI側での指定が必須です。
  - 保存形式: DOM上には `data-temp-id` 属性として保持されます。

### 特殊なターゲット
- **仮想プレースホルダー**: 存在しないページ（例: まだ3ページ目がない状態での `p3-1`）への挿入指示があった場合、実行サービスが一時的なページとプレースホルダーを作成し、そこへ流し込みます。

---

## 2. AIコマンド・パーサー仕様

### 引数パースの「カンマ問題」
- **事象**: `REPLACE_PARAGRAPH(p1, テキスト, カンマあり内容, blockType=h1)` のように、テキスト内にカンマがあると引数が正しく分割されません。
- **解決策**: パーサーは第2引数以降で `key=value` 形式（オプション）を探し、最初のオプションが出現するまでの要素をすべて `text` としてカンマで再結合します。

### 実行の原子性（トランザクション）
- **重要**: `SPLIT`, `MOVE`, `MERGE` など、複数の物理操作（削除+挿入など）を伴うコマンドは、必ず `editor.chain()...run()` を使用して**単一のトランザクション**でコミットします。
  - 個別に `.run()` を呼ぶと、Tiptap/ProseMirrorのインデックス（Pos）が途中で更新され、後続の操作位置が大きくずれる原因になります。

---

## 3. ハイライト・承認システム

### ハイライトの挙動
- コマンド実行直後は `data-command-type` / `data-command-id` 属性が付与され、CSSで着色されます。
- **承認 (Approve)**:
  - `DELETE` 以外: ハイライト属性を削除して確定。
  - `DELETE`: `deleteSelection()` でノードを物理削除。
- **破棄 (Reject)**:
  - `INSERT` / `SPLIT` (新規部): スナップショットに存在しないため物理削除。
  - その他: 実行前のスナップショットから属性・テキストを復元。

### ゴーストハイライトのクリーンアップ
- 連続編集で古いコマンドが新しいコマンドによって「上書き（上乗せ）」された場合、古いコマンドIDに関連付けられている全てのDOMノードから属性を物理的に削除し、UI上の混乱を防ぎます。

### 属性ベースの全走査
- 承認・破棄時は ID 検索ではなく、ドキュメント全体を走査して `data-command-id` を直接追跡します。これにより、SPLITなどで1つのコマンドが複数のノードにまたがっても、漏れなく処理が可能です。
- **後方一括処理**: ターゲットを `pos` の降順（後ろから）でソートして処理することで、ノード削除によるインデックスのズレを回避します。

---

## 4. エディタ・ロック機構

承認待ちの間、ユーザーの意図しない編集を完全に防ぐための仕様です。

- **論理ロック**: Tiptapの `setEditable(false)` を使用。
  - `App.tsx` 内で、タイマー (50ms) とイベントリスナーによる三重ガードを行い、ロック状態を死守します。
- **物理ロック (セレクティブ・ロック)**: 
  - ツールバー、サイドバー、エディタの非ハイライト領域に `pointer-events: none` を適用。
  - ハイライト領域 (`[data-command-type]`) のみ `pointer-events: auto` とすることで、個別承認ポップアップの操作（ホバー/クリック）のみを許可します。

---

## 5. 実装上の重要ポイント・トラブルシューティング

- **Zustandの状態参照**: ループ内や非同期コールバック内でハイライト状態を参照する場合、Reactのクロージャによる「古い状態」のキャプチャを避けるため、必ず `useCommandHighlightStore.getState()` を使用して最新状態を取得してください。
- **物理ノード変換**: `blockType` (h1, h2等) の変更は、単なる属性付与ではなく `setNodeMarkup` を通じてTiptapのノードタイプ自体を物理的に変換します。
- **検索範囲**: ID検索ユーティリティ（`paragraphOperations.ts` 等）は、`paragraph` ノードだけでなく `heading` ノードも常に走査対象に含める必要があります。
- **MOVEの位置補正**: `MOVE_PARAGRAPH` の実行において、ソースノードが挿入先より前方にある場合、削除によるドキュメント長の縮小分（`sourcePos < insertPos`）を補正して位置を決定する必要があります。
