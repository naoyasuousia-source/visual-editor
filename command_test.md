## 概要
これは、解決困難な要件を効率的に解決するためのファイルである。要件に関する重要事項を随時追記修正することで、AIが状況を動的に把握しやすくするとともに、他のモデルも即座に状況を把握できるようにする。

内容は以下の通りとする。
1.未解決要件、2.未解決要件に関するコード変更履歴（毎回、分析結果・方針・変更内容を詳細に記述する）3.分析中に気づいた重要ポイント（試してだめだったこと、仮設、制約条件等...）、4.解決済み要件とその解決方法、5.要件に関連する全ファイルのファイル構成、6.要件に関連する技術スタック、7.要件に関する機能の動作原理（依存関係含む）

## ワークフロー

### 現状把握と分析
まず、1を確認して未解決要件を把握する。
その後、2～7を参考にしつつ、コードベースを分析して、現状の問題点を考える。
同時に、3を更新する。

### 5～7の更新
分析を踏まえて、5～7を更新する。
***常に、最新の要件に関連する記述を行い、最新の要件に関係のない記述は削除すること。***

### コード編集作業
次に、実際に要件を満たすためにコーディングを行う。途中、適宜3を更新する。

### 作業終了後
作業後は、ユーザーから、フィードバックを受けたのち、ユーザーの指示に従って、1,4を更新する。
***勝手に1,4を編集しないこと。***
----------------------------------------
### 目的
**外部AI向けのコマンドロジックの大改造を行う**
### 要件
- **コマンドの刷新**
コマンドは以下だけに限定する。
***REPLACE_PARAGRAPH***
（ターゲット：各段落に振られたid（例：p2-1））
（オプション：太字タグ、brタグ挿入上付き下付き文字タグは指定可能：挿入テキスト内に直書きさせる）
（オプション：ブロック要素4択、文字揃え3択、段落下余白4択、インデント0～4→引数とする）
- 既存テキストの修正はすべてこれで行う。
- 自動修正後、置き換えられた段落全体を色付けハイライトし、ホバーすると、ポップアップで、変更前と変更後の比較を見ることができ、承諾or破棄を選べる。

***INSERT_PARAGRAPH***
（ターゲット：既存段落のid（例：p2-1））
（オプション：太字タグ、brタグ挿入上付き下付き文字タグは指定可能：挿入テキスト内に直書きさせる）
（オプション：ブロック要素4択、文字揃え3択、段落下余白4択、インデント0～4→引数とする）
- targetの段落の直後に挿入。
- AI側で仮idを発行する。（連続挿入可能にするため）
- 自動修正後、挿入された段落全体を色付けハイライトし、ホバーで承諾or破棄を選べる。

***DELETE_PARAGRAPH***
（ターゲット：各段落に振られたid（例：p2-1））
- targetの段落を削除。
- 自動修正後、削除された段落位置を色付けハイライトし、ホバーで削除段落の内容を見ることができ、承諾or破棄を選べる。

***MOVE_PARAGRAPH***
（ターゲット：移動段落のid、移動先のid）
- targetの段落を移動先のidの直後に移動。
- 自動修正後、移動先で色付けハイライトし、ホバーで承諾or破棄を選べる。

***SPLIT_PARAGRAPH***
（ターゲット：分割したい段落のid、分割位置（テキスト引用で分割位置直前の文字列と分割位置直後の文字列を指定））
- targetの段落を分割位置で分割し、新段落に仮idを振る。
- 自動修正後、分割された段落を色付けハイライトし、ホバーで承諾or破棄を選べる。

***MERGE_PARAGRAPH***
（ターゲット：結合したい段落のid、結合先のid）
- 結合したい段落を結合先のidの直後に結合。
- 自動修正後、結合先で色付けハイライトし、ホバーで承諾or破棄を選べる。

- **承認or破棄ロジックの刷新**
現在は、自動修正後、全体の承認or破棄のみを選択できるが、上で記述したように、部分的に承認or破棄を選択できるようにする。（全体の承認、破棄も引き続き行えるようにし、全体承認、破棄が選択されたら、部分選択されていない段落が残っていても、自動保存後、自動編集フローは終了とする）
### 注意
**ユーザーの指示があるまで、絶対にセクション1,4を編集しないこと**
**rules.mdに従うこと**
**ブラウザを立ち上げての確認はしないこと**

----------------------------------------
# 以下、AIが自動的に更新する部分
----------------------------------------
## 1. 未解決要件
・test-commands-comprehensive.txt.のテストセット1をコマンドエリアに入れても、有効コマンドとして処理されず、保護上書きが発動してしまう。（その後コンソールには何も表示されていない）→**同じ状態のまま**

## 2. 未解決要件に関するコード変更履歴

### 重要な技術的発見事項

#### 段落ID管理
- 段落ID形式: Paginatedモードは`p{page}-{paragraph}` (例: p1-2)、Wordモードは`p{number}` (例: p5)
- **修正**: `isOfficialId` が `p\d+-\d+` (Paginated) に加え、`p\d+` (Word) も許容するように正規表現を更新。
- 仮ID形式: `temp-{uuid}` - INSERT/SPLIT実行時に自動生成

#### HTMLコメントパースの堅牢化
- **問題**: マーカーやコマンド内の空白（`<!--AI_COMMAND_START-->` vs `<!-- AI_COMMAND_START -->`）に敏感すぎてパースに失敗していた。
- **修正**: `COMMAND_START_REGEX` 等に `/<!--\s*...\s*-->/` を使用し、ホワイトスペースを許容。
- 各コマンド抽出も正規表現ベースで堅牢化。

#### 引数パース（カンマ問題）の解決
- **問題**: `REPLACE_PARAGRAPH(p1, Text with, comma, blockType=p)` のようにテキスト内にカンマがあると、引数が分割されすぎてオプションが正しく抽出されなかった。
- **修正**: 2番目以降の引数から `=` (key=value形式) を探すロジックを導入。`=` が最初に出現するまでの要素をすべて「テキスト」として再結合（カンマを復元）し、それ以降を「オプション」として扱うように改善。
- 引数抽出全体も `indexOf('(')` から `lastIndexOf(')')` までを取得するよう変更し、ネストしたカッコへの耐性を向上。

#### コマンド検出の一貫性
- `hasNewCommands()` が単なる文字列マッチではなく、`extractCommands()` を通じて「実際に有効なコマンドが1つ以上あるか」を確認するように変更。

### 最終修正履歴（デバッグ用）

#### 修正1: HTMLマーカー・コマンド抽出の正規表現化
**ファイル**: `src/v2/utils/htmlCommentParser.ts`
**修正**: 固定文字列マッチから `RegExp` マッチへ変更。空白許容。

#### 修正2: WordモードIDのサポート
**ファイル**: `src/v2/utils/paragraphIdManager.ts`
**修正**: `isOfficialId`, `extractParagraphNumber` 等で `p{number}` 形式をサポート。

#### 修正3: 引数の高度な抽出と再結合
**ファイル**: `src/v2/utils/newCommandParser.ts`
**修正**: `extractArguments` の堅牢化、および `parseReplaceParagraph` / `parseInsertParagraph` でのテキストパーツ再結合ロジックの追加。

#### 修正4: AIガイドの更新 (反映済み)
**ファイル**: `src/v2/utils/aiMetadata.ts`

#### 修正5: 検出ロジックの同期
**ファイル**: `src/v2/hooks/useCommandParser.ts`
**修正**: `hasNewCommands` のロジックを `extractCommands` ベースに統一。

### 重要な実装詳細

#### ハイライトカラー (content.css)
- REPLACE: 青 `rgba(59, 130, 246, 0.2)`
- INSERT: 緑 `rgba(34, 197, 94, 0.2)`
- DELETE: 赤 + opacity:0.5 + 取り消し線
- MOVE: 紫 `rgba(168, 85, 247, 0.2)`
- SPLIT: オレンジ `rgba(249, 115, 22, 0.2)`
- MERGE: 青緑 `rgba(20, 184, 166, 0.2)`

#### UIコンポーネント統合 (App.tsx)
- `useCommandApprovalController()` - ホバー検知とポップアップ制御
- `CommandPopup` - activePopupが存在する場合のみ表示
- `CommandApprovalBar` - showApprovalBar && pendingCount > 0で表示

## 3. 現在のシステム状態と既知の問題

### 実装済み機能
- ✅ 6種類の新コマンド（REPLACE/INSERT/DELETE/MOVE/SPLIT/MERGE）
- ✅ 段落IDシステム (Paginated/Word両モード対応)
- ✅ 堅牢なHTMLコメントパーサー（空白許容）
- ✅ 高度な引数パーサー（テキスト内のカンマ対応）
- ✅ ハイライトシステム (6色・個別承認UI)
- ✅ AIガイド自動生成 (各モードのID形式を動的に反映)

### 既知の制約
- テキスト引数内に `=` が含まれていると、誤ってオプションの開始とみなされる可能性がある。
- Tiptapのノード位置計算は常に更新が必要（コマンド実行によってPosがずれるため、一括実行が望ましい）。

### デバッグ時の確認ポイント
1. `htmlCommentParser` が `<!-- AI_COMMAND_START -->` を見つけられているか。
2. `isOfficialId` が現在のエディタモード（Paginated/Word）のIDを正しく検証できているか。
3. `extractArguments` がカッコ内の引数全てを配列として取得できているか。
4. `parseReplaceParagraph` 等の再結合ロジックが、期待通りテキストとオプションを分離できているか。

## 4. 解決済み要件とその解決方法
（ユーザーの指示待ち - このセクションはユーザーが更新）

## 5. 新コマンドシステム関連ファイル構成

### 型定義
- `src/v2/types/command.ts` - 新コマンド型、オプション、実行結果

### ユーティリティ
- `src/v2/utils/paragraphIdManager.ts` - ID生成・検証 (Wordモード対応)
- `src/v2/utils/paragraphOperations.ts` - 段落検索・操作
- `src/v2/utils/newCommandParser.ts` - 引数再結合ロジック含む
- `src/v2/utils/htmlCommentParser.ts` - 正規表現ベースへの進化
- `src/v2/utils/aiMetadata.ts` - AIガイド生成

### フック
- `src/v2/hooks/useCommandParser.ts` - 検出ロジックを抽出ベースに統一
- `src/v2/hooks/useAutoEdit.ts` - フロー全体を管理

## 6. 技術スタック詳細

### フロントエンド
- **React 18**
- **TypeScript**
- **Tiptap / ProseMirror**
- **Tailwind CSS**

### ユーティリティ
- **正規表現 (RegExp)** - 堅牢なパースの中核
- **uuid (v4)** - 仮ID生成用

### データフロー
```
HTMLファイル保存
  ↓ (useFileSystemWatcher)
有効コマンドの検出 (useCommandParser -> htmlCommentParser)
  ↓ (1つ以上あれば実行へ、無ければ保護上書き)
コマンドパース (newCommandParser: テキストとオプションの分離)
  ↓
コマンド実行 (newCommandExecutionService: ProseMirror Transform)
  ↓
ハイライト登録 & UI表示
```

## 7. 新コマンドシステム動作原理

### コマンド検出・抽出フロー
1. `useFileSystemWatcher` が変更を検知。
2. `htmlCommentParser` (正規表現) を使用して、マーカーに囲まれたエリアを抽出。
3. 同様に正規表現で、コメント形式のコマンド行をすべて取得。

### 引数パース原理 (Advanced Split)
- カッコ内の文字列をカンマで機械的に分割。
- 得られた要素の配列に対し、後ろから（オプションがある場合）処理を行い、オプションでない部分はすべて `text` としてカンマを付けて再結合する。これにより「テキスト内のカンマ」を安全に扱える。

### 個別承認の仕組み
- `data-command-type` 等の属性をノードに付与することでCSS（content.css）でのハイライトを実現。
- 承認時はそれらの属性を削除し、破棄時はキャプチャしておいたスナップショットに戻す。

