# v2コードベース・リファクタリング計画書

## 1. 目的
`rules.md` に定義された厳格なコーディング規則に基づき、`src/v2` 内のデッドコード削除、分散したロジックの整理、およびアーキテクチャの適正化を行い、コードの品質と保守性を向上させる。

## 2. 方針
- **デッドコードの徹底排除**: 未使用のコンポーネント、変数、コメントアウトされたコードを即座に削除する。
- **4層アーキテクチャの遵守**: Logic (utils/lib) → External Actions (services) → Bridge (hooks) → UI (components) の分離を徹底する。
- **ロジックの集約**: コンポーネント内に記述されている複雑なハンドラや条件分岐を `hooks/` に移動する。
- **制約事項の遵守**: 1ファイル300行制限の遵守、`any`の禁止、直接DOM操作の禁止（hooks経由に限定）を徹底する。
- **v1への不干渉**: `src/v1` および関連ファイルには一切触れない。

## 3. 実施タスク

### フェーズ1: 不要なコードの整理（Dead Code Cleanup）
- [ ] `src/v2/components/common/editor-menus/ImageBubbleMenu.tsx` の削除（未使用かつロジックが重複）。
- [ ] `src/v2/app/App.tsx` 内のコメントアウトされたコードおよび未使用のインポートを削除。
- [ ] `src/v2/hooks/useIMEControl.ts` の戻り値のうち、使用されていない `handleCompositionStart/End` を削除（または適切に使用するよう修正）。

### フェーズ2: ロジックの集約とフックの最適化
- [ ] `src/v2/hooks/index.ts` の更新: 全てのカスタムフックを一括エクスポートするように修正。
- [ ] `App.tsx` のリファクタリング:
    - `tempEditor` を使わずにエディタインスタンスを管理する構成への見直し。
    - コンポーネントの記述をUI統合に専念させる。
- [ ] ロジックの移動:
    - `Toolbar.tsx` 内の見出し/段落切替ロジックを `useFormattingActions.ts` 等へ移動。
    - `ImageContextMenu.tsx` 内の画像検出・選択ロジックを `useImageActions.ts` へ移動。

### フェーズ3: ファイル分割と規約への適合
- [ ] `src/v2/lib/customImage.ts` の分割: 300行を超えているため、拡張定義本体と NodeView 定義等に分割する。
- [ ] 型安全の強化: 暗黙的な `any` の排除と、必要に応じた `unknown` + 型ガードの導入。
- [ ] ディレクトリ名の再確認: コンポーネント名とファイル名の不整合（例: `App.tsx` の中身が `EditorV3`）を整理。

### フェーズ4: 最終確認とビルド検証
- [ ] `npm run build` による型チェックとビルドの成功確認。
- [ ] 既存機能（画像操作、リンク、IME、ファイル入出力）の動作確認。

## 4. スケジュール（想定）
1. フェーズ1: 整理（即時）
2. フェーズ2: ロジック集約（本セッション内）
3. フェーズ3: 分割・リファクタ（本セッション内）
4. フェーズ4: 検証（完了前）
