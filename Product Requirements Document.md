【要件定義書】

【目的】

このフォルダに存在する「AI-Link Editor（オリジナルエディタ）」を、React・Tailwind CSS・shadcn/uiというスタックで、「AI-Link Editor ver2.0」という名前でイチから作り直し、堅牢性と機能を向上させる。

【スタック】

- **Framework**: React (TypeScript) のコンポーネントでwebアプリを組み立て、本体のHTMLは最低限の記述にとどめる。
- **Styling**: Tailwind CSSのみで行うこと。他のライブラリの組み込みスタイルも必ず Tailwind のクラスへ置換・統一すること。
（style属性は絶対使用しないこと）
- **UI Components**: shadcn/ui をベースとする。
- **Library**: エディタエンジンにはTiptapを採用し、A4ページネーションはTiptapの拡張機能（Extension）またはReact側のロジックで実装する。
機能実装の際は、その機能に最も適したReactライブラリや、無料の外部ライブラリを積極的に導入する。また、実装したい機能がライブラリとして提供されていない場合は、独自でロジックを組む。外部ライブラリや独自ロジックは、ロジック自体はコンポーネントファイルと別で管理し、カスタムフックでコンポーネントとつなぐ。
（ロジックとUIの分離を徹底し、コンポーネントの中に独自ロジックを書かないようにする。）

オリジナルエディタのソースコードの転用：挿入画像、ダイアログ中の説明文、ライブラリで再現不可能な独自ロジックに関しては、オリジナルエディタのソースコードをコピペ利用する。

【設計思想】

・docxやpdfでは、ファイルのテキストデータ中に、段落ごとに固有のページ番号・段落番号が埋め込まれていないため、生成AIと編集箇所の共有がスムーズにできず、スピーディーにAIアシスト下での長文精密編集ができないという問題をHTMLファイルにidタグを埋め込むことで解決。
・Wordのようなビジュアルエディタをwebアプリとして再現し、ユーザーは完全にGUIのみで、wordに劣らないクオリティで文書編集、ローカル保存、上書きを行うことができる。
・HTMLとして出力されたファイルを生成AIにアップロードすると、生成AIは段落固有のidを認識し、場所指定で編集アシストができる。
・また、Antigravity等のファイル編集AIエージェントはHTMLファイルにAPI的指示を書くと、ブラウザは、webAPIにより読み込みファイルの更新を検知し、指示をエディタに反映させることで、実質的なリアルタイム同期AI編集も可能。
・また、標準モード（多機能）とWord互換モード（機能は少ないが、manmothライブラリを使ったdocxとの完全互換が可能）を切替可能。
・フロントエンド完結
・PCかつchrome、edge環境推奨（ほかのデバイス、環境は警告出す）
・ダークモードも対応させる

【UI・機能】

【1. 編集領域】：
・Wordと同様のA4ページごとの分割されているレイアウト。絶対にA4比率を維持する。
・バグなく入力およびメニューの実行ができるのが望ましい。
・日本語IME入力中のEnterキー押下では段落更新を行わず、変換確定のみを行う。確定後のEnter押下で初めて新しい段落を作成する制御を徹底する。
・画像のペーストは受け付けない。テキストはプレーンテキストとして、ペースト。
・テキストがページ下端（余白内部）に達した場合、自動的に次のページを生成し、キャレットと溢れたテキストを次ページへ移動させる

【2. メニューバー】

1. 全体レイアウト設計
コンテナ: 画面上部に固定。コンテンツに応じた高さ。背景色設定あり。
配置: 左寄せレイアウト。一部のアクションボタン（ヘルプ、寄付、モード切替）のみ右端へ配置（margin-left: auto 相当）。
モード制御: 「標準モード」と「Word互換モード」の2つのステートを持ち、ステートに応じて表示するコンポーネントセットを切り替える。
2. 標準モード (Standard Mode) コンポーネント構成
左から右への配置順序。

(1) アプリケーションロゴ
静的画像コンポーネント。クリックイベントなし。
(2) ファイルメニュー (DropdownMenu)
トリガー: 「ファイル ▾」ボタン
メニュー項目:
保存: Ctrl+S ショートカット対応。
名前を付けて保存: 別名保存ダイアログ呼び出し。
上書き保存: Ctrl+S ショートカット対応。
HTMLファイルを開く: Ctrl+O。ローカルファイル読み込み。
Wordファイル(docx)を開く: ※Wordモード時のみ表示
PDFとして出力: ブラウザの印刷ダイアログ（PDF保存）呼び出し。
[サブメニュー] ハイパーリンク:
リンク先に追加
リンクを生成
リンクを削除
[サブメニュー] 画像を挿入:
Dropboxから挿入
Web上の画像を挿入
[サブメニュー] 余白:
サイズ選択 (S / M / L)
(3) 表示メニュー (DropdownMenu)
トリガー: 「表示 ▾」ボタン
メニュー項目:
ページ番号: チェックボックス付きアイテム（表示/非表示トグル）。
段落番号: チェックボックス付きアイテム（表示/非表示トグル）。
(4) 書式ツールバー (Toggle Group)
各ボタンはトグル（On/Off）またはアクションとして機能。

太字 (Bold)
斜体 (Italic)
下線 (Underline)
取り消し線 (Strikethrough)
上付き文字 (Superscript): アイコン表示
下付き文字 (Subscript): アイコン表示
(5) ハイライト制御 (Popover / Custom UI)
トリガー: ハイライトアイコンボタン。
コンテンツ: カラーパレット（黄、赤、青、緑）および「取消」ボタン。
(6) フォント設定 (DropdownMenu)
トリガー: 「Font ▾」ボタン
メニュー項目:
[サブメニュー] ブロック要素 (見出し設定):
見出し1 (h1)
見出し2 (h2)
見出し3 (h3)
本文 (p)
サブテキスト (h6)
[サブメニュー] フォントカラー:
カラーパレット選択 (テーマカラー数色 + デフォルト黒)
[サブメニュー] フォントファミリー:
フォント一覧 (游ゴシック, 游明朝, Meiryo, BIZ UD, Noto Sans JP, Serif, Arial等)
(7) 段落設定 (DropdownMenu)
トリガー: 「段落スタイル ▾」ボタン
メニュー項目:
[サブメニュー] 配置: 左揃え / 中央揃え / 右揃え
[サブメニュー] 段落下の余白: サイズ選択 (XS / S / M / L / XL)
[サブメニュー] 行間: サイズ選択 (S / M / L)
[サブメニュー] インデント:
インデント増 (＋)
インデント減 (ー)
ぶら下げインデント設定
(8) ページ操作 (Single/Grouped Buttons)
ページ追加: 現在位置の後に新規ページを追加。
ページ削除: 現在のページを削除。
(9) ズーム制御 (Grouped Buttons + Label)
縮小 (-) ボタン
現在の倍率 テキスト表示 (例: 100%)
拡大 (+) ボタン
(10) ジャンプ機能 (Input Unit)
ラベル: キーボードショートカット (Ctrl+J) の案内。
入力フィールド: ページ番号と段落番号を指定してジャンプ (例: "1-1")。
3. Word互換モード (Word Compatible Mode) コンポーネント構成
モード切替により、以下の変更を適用する。

表示・非表示の変更
非表示: PDF出力、ハイパーリンク、画像挿入メニュー、余白メニュー、ハイライト制御、フォント設定、段落設定、ページ操作ボタン。
追加: 「Wordファイル(docx)を開く」メニュー。
Wordモード固有コンポーネント
段落番号チェックボックス:
ツールバー上に直接配置（標準モードの「表示メニュー」の代わり）。
Word用ブロックスタイル選択 (Select):
ドロップダウンリストで選択 (本文, 見出し1, 見出し2, 見出し3, サブテキスト)。
Word用ジャンプ入力:
標準モードとは異なるプレースホルダーとロジック (段落通し番号 "15" など) を持つ入力欄。
4. 右側コンポーネント (共通・右端固定)
(1) モード切替ボタン (Button)
機能: 標準モード / Word互換モード のステートをトグルする。
表示変化: モードに応じてボタンのテキスト（「Word互換モードに切替」⇔「標準モードに切替」）と配色（スタイルバリアント）を切り替える。
(2) ヘルプボタン (Button / Dialog Trigger)
機能: ヘルプ/使い方ダイアログ (Modal) を開く。
アイコン: 疑問符 (?) アイコン。
(3) 開発支援ボタン (Button / Dialog Trigger)
機能: 寄付・開発者情報ダイアログ (Modal) を開く。
表示: アイコン ＋ 「開発を応援」テキスト。目立つ配色（アクセントカラー）。

【3. サイドバー】

サムネイル表示：編集領域をキャプチャした省略なしのサムネイルが表示され、任意ページクリックでジャンプ可能。サイドバーは表示/非表示切替可能。

【4. 画像右クリックメニュー】

1. 概要
トリガー: エディタ内の画像要素に対する右クリック (ContextMenu) イベント。
UIコンポーネント: ContextMenu (shadcn/ui) または独自の Popover / Fixed Position Menu。
動作: カーソル位置（マウスポインタ座標）付近にメニューを表示する。
2. メニュー項目構成
上から順に配置。

(1) [サブメニュー] サイズ
画像の表示サイズを変更する。

親項目: 「サイズ」
サブメニュー項目:
XS: 極小サイズ (width: 15%程度)
S: 小サイズ (width: 30%程度)
M: 中サイズ (width: 50%程度)
L: 大サイズ (width: 80%程度)
XL: 最大サイズ (width: 100%)
(2) 枠線 (Toggle)
項目名: 「枠線」
機能: 画像周囲の枠線 (border) の表示/非表示をトグル切り替えする。
(3) タイトル (Dialog Trigger)
項目名: 「タイトル」
機能: 画像タイトル編集ダイアログを開く。
ダイアログ内機能:
タイトル入力フィールド
フォントサイズ選択 (本文サイズ / サブテキストサイズ)
(4) キャプション (Dialog Trigger)
項目名: 「キャプション」
機能: 画像キャプション編集ダイアログを開く。
ダイアログ内機能:
キャプション入力エリア (複数行対応 textarea)
(5) タグ (Dialog Trigger)
項目名: 「タグ」
機能: 画像タグ編集ダイアログを開く。
ダイアログ内機能:
タグ入力フィールド (カンマ区切りテキスト)

【5. 段落番号管理ロジック (ユニーク機能)】
概要
ドキュメント内の全てのブロック要素（p, h1〜h6）に対し、ユニークなIDと連番を付与する。 この処理は、コンテンツ内容が変更されるたび（入力、改行、ページ追加・削除時など）に実行し、常に最新の状態を維持する。

一意なID (DOM ID) の付与ルール
標準モード (Standard Mode)
「ページごとの独立した連番」として管理する。

フォーマット: p{ページ番号}-{該当ページ内での連番}
例: 1ページ目の1つ目の段落 → id="p1-1"
例: 2ページ目の3つ目の段落 → id="p2-3"
データ属性: data-para="{該当ページ内での連番}"
CSSの ::before 疑似要素等で番号を表示するために使用する。
Word互換モード (Word Compatible Mode)
「ドキュメント全体での通し連番」として管理する（Wordの行番号/段落番号の概念に近い）。

フォーマット: p{ドキュメント全体での通し連番}
例: ドキュメント全体の1つ目の段落 → id="p1"
例: ページを跨いで通算15番目の段落 → id="p15"
データ属性: data-para="{ドキュメント全体での通し連番}"
実行タイミング
以下の操作が発生した直後に、全ページの全段落を再走査して番号を振り直す関数 (renumberParagraphs) を実行する。

エディタ初期化時
テキストの改行 (Enter)、削除 (Backspace/Delete) 時
画像の挿入・削除時
ページの追加・削除時
ブロック要素のタグ変更時（例：本文→見出し1への変更）
モード切替時（標準⇔Word互換）

【6. ai-image-index 仕様 (ユニーク機能)】
概要
ドキュメント内に含まれる画像 (imgタグ) に付随するメタデータ（タイトル、キャプション、タグなど）を、HTMLの表示構造とは分離して管理するための不可視領域。 これにより、AI（LLM）がHTMLを解析する際、画像の文脈情報を見落とすことなく、かつHTMLの表示スタイルに影響を与えずにデータを保持できる。

DOM構造
配置場所: #pages-container 直下の末尾（または #workspace 内の不可視領域）。
コンテナID: <div id="ai-image-index" style="display: none;"></div>
Wordモード時の挙動: WordモードはHTML構造をAIに渡す目的ではない（Wordへのコピペ用）ため、この要素は生成しない（または空にする）。
データ保持形式
ai-image-index 内には、エディタ内の img タグ1つにつき、対応する div.figure-meta 要素を1つ作成する。

<div class="figure-meta"
data-src="{画像のsrc属性値}"
data-title="{画像タイトル}"
data-caption="{画像キャプション}"
data-tag="{検索用タグ}"
data-anchor="{直近の段落ID}">
</div>
data-src: 画像を一意に特定するためのキー（画像のURL）。
data-title: ユーザーが設定した画像のタイトル。
data-caption: ユーザーが設定した画像の長い説明文。
data-tag: 画像検索や分類用のタグ（カンマ区切り）。
data-anchor: その画像が紐づく（または直後にある）段落のID (p1-1 等)。これにより、AIは「どの文章の近くにこの画像があるか」を理解できる。
同期ロジック (Sync Logic)
段落番号の更新処理と同様のタイミングで、以下の同期処理を行う。

既存データの退避: 現在の ai-image-index 内のデータを、data-src をキーにしてメモリ上に一時保存する。
DOMの再構築:
エディタ内の全 img タグを走査する。
各画像に対し、メモリ上のデータからメタデータ（タイトル等）を引き継ぐ。
新規画像であれば、空のメタデータを作成する。
現在のDOM位置に基づき data-anchor (直近の段落ID) を再計算してセットする。
書き込み: ai-image-index の中身を、再構築した div.figure-meta リストで完全に上書きする。