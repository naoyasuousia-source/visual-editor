【要件定義書】

【目的】

AI-Link Editor v2の、さらなる機能向上を目指す。

【スタック】

- rules.mdに従い、react(TypeScript)・ Tailwind・shadcn/ui・外部ライブラリ・独自ロジック・viteを用いる。エディタエンジンにはTiptapを採用し、A4ページネーションはTiptapの拡張機能（Extension）またはReact側のロジックで実装する。

【オリジナルエディタのソースコードの転用】

- 挿入画像、ダイアログ中の説明文、ライブラリで再現不可能な独自ロジックに関しては、オリジナルエディタのソースコードをコピペ利用する。

【設計思想】

・docxやpdfでは、ファイルのテキストデータ中に、段落ごとに固有のページ番号・段落番号が埋め込まれていないため、生成AIと編集箇所の共有がスムーズにできず、スピーディーにAIアシスト下での長文精密編集ができないという問題をHTMLファイルにidタグを埋め込むことで解決。
・Wordのようなビジュアルエディタをwebアプリとして再現し、ユーザーは完全にGUIのみで、wordに劣らないクオリティで文書編集、ローカル保存、上書きを行うことができる。
・HTMLとして出力されたファイルを生成AIにアップロードすると、生成AIは段落固有のidを認識し、場所指定で編集アシストができる。
・また、Antigravity等のファイル編集AIエージェントはHTMLファイルにAPI的指示を書くと、ブラウザは、webAPIにより読み込みファイルの更新を検知し、指示をエディタに反映させることで、実質的なリアルタイム同期AI編集も可能。
・また、標準モード（多機能）とWord互換モード（機能は少ないが、manmothライブラリを使ったdocxとの完全互換が可能）を切替可能。
・フロントエンド完結
・PCかつchrome、edge環境推奨（ほかのデバイス、環境は警告出す）
・ダークモードも対応させる

【要件】

【 編集領域】
・画像のペーストは受け付けない。テキストはプレーンテキストとして、ペースト。

【段落番号管理ロジック (ユニーク機能)】
概要
ドキュメント内の全てのブロック要素（p, h1〜h6）に対し、ユニークなIDと連番を付与する。 この処理は、コンテンツ内容が変更されるたび（入力、改行、ページ追加・削除時など）に実行し、常に最新の状態を維持する。

一意なID (DOM ID) の付与ルール
標準モード (Standard Mode)
「ページごとの独立した連番」として管理する。

フォーマット: p{ページ番号}-{該当ページ内での連番}
例: 1ページ目の1つ目の段落 → id="p1-1"
例: 2ページ目の3つ目の段落 → id="p2-3"
データ属性: data-para="{該当ページ内での連番}"
CSSの ::before 疑似要素等で番号を表示するために使用する。
（★UI上の表示は、[1]のようにする）
（★各段落の一文字目から固定距離離れた距離に表示し、各段落番号は縦一列に並ぶようにする）
Word互換モード (Word Compatible Mode)
「ドキュメント全体での通し連番」として管理する（Wordの行番号/段落番号の概念に近い）。

フォーマット: p{ドキュメント全体での通し連番}
例: ドキュメント全体の1つ目の段落 → id="p1"
例: ページを跨いで通算15番目の段落 → id="p15"
データ属性: data-para="{ドキュメント全体での通し連番}"
実行タイミング
以下の操作が発生した直後に、全ページの全段落を再走査して番号を振り直す関数 (renumberParagraphs) を実行する。

エディタ初期化時
テキストの改行 (Enter)、削除 (Backspace/Delete) 時
画像の挿入・削除時
ページの追加・削除時
ブロック要素のタグ変更時（例：本文→見出し1への変更）
モード切替時（標準⇔Word互換）

【ai-image-index 仕様 (ユニーク機能)】
概要
ドキュメント内に含まれる画像 (imgタグ) に付随するメタデータ（タイトル、キャプション、タグなど）を、HTMLの表示構造とは分離して管理するための不可視領域。 これにより、AI（LLM）がHTMLを解析する際、画像の文脈情報を見落とすことなく、かつHTMLの表示スタイルに影響を与えずにデータを保持できる。

DOM構造
配置場所: #pages-container 直下の末尾（または #workspace 内の不可視領域）。
コンテナID: <div id="ai-image-index" style="display: none;"></div>
Wordモード時の挙動: WordモードはHTML構造をAIに渡す目的ではない（Wordへのコピペ用）ため、この要素は生成しない（または空にする）。
データ保持形式
ai-image-index 内には、エディタ内の img タグ1つにつき、対応する div.figure-meta 要素を1つ作成する。

<div class="figure-meta"
data-src="{画像のsrc属性値}"
data-title="{画像タイトル}"
data-caption="{画像キャプション}"
data-tag="{検索用タグ}"
data-anchor="{直近の段落ID}">
</div>
data-src: 画像を一意に特定するためのキー（画像のURL）。
data-title: ユーザーが設定した画像のタイトル。
data-caption: ユーザーが設定した画像の長い説明文。
data-tag: 画像検索や分類用のタグ（カンマ区切り）。
data-anchor: その画像が紐づく（または直後にある）段落のID (p1-1 等)。これにより、AIは「どの文章の近くにこの画像があるか」を理解できる。
同期ロジック (Sync Logic)
段落番号の更新処理と同様のタイミングで、以下の同期処理を行う。

既存データの退避: 現在の ai-image-index 内のデータを、data-src をキーにしてメモリ上に一時保存する。
DOMの再構築:
エディタ内の全 img タグを走査する。
各画像に対し、メモリ上のデータからメタデータ（タイトル等）を引き継ぐ。
新規画像であれば、空のメタデータを作成する。
現在のDOM位置に基づき data-anchor (直近の段落ID) を再計算してセットする。
書き込み: ai-image-index の中身を、再構築した div.figure-meta リストで完全に上書きする。

【ダークモード（新機能）】

UIで通常モードとダークモードを切り替えられるプロフェッショナルな仕様にする。

【Antigravity下でのリアルタイム同期AI編集（新機能）】

Antigravity等のファイル編集AIエージェントがHTMLファイルにAPI的指示を書くと、ブラウザは、webAPIにより読み込みファイルの更新を検知し、指示をエディタに反映させることで、実質的なリアルタイム同期AI編集も可能にする。
（出力用ファイルにAI向けのAPI仕様書入れとく）

（変更箇所色付けて受け入れるor拒否機能つける）